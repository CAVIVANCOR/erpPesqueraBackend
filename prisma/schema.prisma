generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model AccesoInstalacion {
  id                          BigInt                     @id @default(autoincrement())
  sedeId                      BigInt
  areaDestinoVisitaId         BigInt?
  empresaId                   BigInt?
  tipoAccesoId                BigInt
  tipoPersonaId               BigInt?
  motivoId                    BigInt?
  tipoEquipoId                BigInt?
  fechaHora                   DateTime
  nombrePersona               String?
  tipoDocIdentidadId          BigInt?
  numeroDocumento             String?
  vehiculoNroPlaca            String?
  vehiculoMarca               String?
  equipoMarca                 String?
  equipoSerie                 String?
  personaFirmaDestinoVisitaId BigInt?
  observaciones               String?
  incidenteResaltante         Boolean                    @default(false)
  descripcionIncidente        String?
  imprimeTicketIng            Boolean                    @default(false)
  urlImpresionTicket          String?
  urlDocumentoVisitante       String?
  createdAt                   DateTime                   @default(now())
  vehiculoColor               String?
  vehiculoModelo              String?
  accesoSellado               Boolean                    @default(false)
  fechaHoraSalidaDefinitiva   DateTime?

  tipoAcceso         TipoAccesoInstalacion @relation(fields: [tipoAccesoId], references: [id])
  tipoPersona        TipoPersona?          @relation(fields: [tipoPersonaId], references: [id])
  motivoAcceso       MotivoAcceso?         @relation(fields: [motivoId], references: [id])
  detalles   AccesoInstalacionDetalle[]
  tipoEquipo        TipoEquipo?          @relation(fields: [tipoEquipoId], references: [id])
}

model AccesoInstalacionDetalle {
  id                   BigInt               @id @default(autoincrement())
  accesoInstalacionId  BigInt
  fechaHora            DateTime
  tipoMovimientoId     BigInt
  areaDestinoVisitaId  BigInt?
  observaciones        String?
  createdAt            DateTime             @default(now())

  accesoInstalacion    AccesoInstalacion @relation(fields: [accesoInstalacionId], references: [id])
  tipoMovimiento       TipoMovimientoAcceso @relation(fields: [tipoMovimientoId], references: [id])
}

model AccesosUsuario {
  id                 BigInt           @id @default(autoincrement())
  usuarioId          BigInt
  submoduloId        BigInt
  puedeVer           Boolean          @default(true)
  puedeCrear         Boolean          @default(false)
  puedeEditar        Boolean          @default(false)
  puedeEliminar      Boolean          @default(false)
  puedeReactivarDocs Boolean          @default(false)
  puedeAprobarDocs   Boolean          @default(false)  // Typo corregido
  puedeRechazarDocs  Boolean          @default(false)  // Typo corregido
  fechaOtorgado      DateTime         @default(now())
  otorgadoPor        BigInt?          // Qui茅n otorg贸 el acceso
  fechaRevocado      DateTime?        // Cu谩ndo se revoc贸
  revocadoPor        BigInt?          // Qui茅n revoc贸 el acceso
  activo             Boolean          @default(true)   // Para soft delete

  usuario        Usuario          @relation(fields: [usuarioId], references: [id])
  submodulo      SubmoduloSistema @relation(fields: [submoduloId], references: [id])
  
  @@unique([usuarioId, submoduloId])
  @@index([usuarioId])
  @@index([submoduloId])
  @@index([activo])
}

model AccionesPreviasFaena {
  id                             BigInt                           @id @default(autoincrement())
  nombre                         String                           @db.VarChar(100)
  descripcion                    String?
  activo                         Boolean                          @default(true)
  paraPescaConsumo               Boolean                          @default(false)
  paraPescaIndustrial            Boolean                          @default(false)

  detalles    DetAccionesPreviasFaena[]
  detallesConsumo DetAccionesPreviasFaenaConsumo[]
}


model Activo {
  id                   BigInt                 @id @default(autoincrement())
  empresaId            BigInt
  tipoId               BigInt
  nombre               String
  descripcion          String?
  cesado               Boolean                @default(false)
  createdAt            DateTime               @default(now())
  updatedAt            DateTime

  tipo        TipoActivo @relation(fields: [tipoId], references: [id])
  permisos    DetallePermisoActivo[]
  embarcacion Embarcacion?
  ordenesMantenimiento OTMantenimiento[]
  contratosServicio       ContratoServicio[]    @relation("ContratoServicioActivo")

}

model AgrupacionEntidad {
  id               BigInt             @id @default(autoincrement())
  nombre           String             @db.VarChar(100)
  descripcion      String?
  esCliente        Boolean            @default(false)
  esProveedor      Boolean            @default(false)

  entidades   EntidadComercial[]
}

/// Modelo centralizado para almacenar archivos adjuntos PDF de cualquier subm贸dulo del ERP Megui.
/// Permite asociar cada archivo a un proceso origen (empresa, pesca, proveedor, etc.) mediante subModuloId.
model ArchivoAdjunto {
  id             BigInt   @id @default(autoincrement()) // Identificador 煤nico del archivo adjunto
  nombreArchivo  String   // Nombre f铆sico del archivo almacenado (ej: permiso-2025-1623456789.pdf)
  rutaRelativa   String   // Ruta relativa de almacenamiento (ej: /uploads/adjuntos/empresa-23/permiso-2025-1623456789.pdf)
  fechaSubida    DateTime @default(now()) // Fecha y hora de subida del archivo
  empresaId      BigInt   // Identificador de la empresa a la que pertenece el archivo adjunto
  subModuloId    BigInt   // Identificador del subm贸dulo o proceso origen (ej: id de pesca, id de empresa, id de proveedor, etc.)
  usuarioSubioId BigInt?  // Usuario que subi贸 el archivo (opcional)
}

model AreaFisicaSede {
  id           BigInt       @id @default(autoincrement())
  sedeId       BigInt
  nombre       String
  descripcion  String?
  cesado       Boolean      @default(false)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime

  sede        SedesEmpresa @relation(fields: [sedeId], references: [id])
}

model AsientoContableInterfaz {
  id               BigInt         @id @default(autoincrement())
  movimientoCajaId BigInt
  fechaContable    DateTime
  cuentaContable   String
  descripcion      String?
  debe             Decimal
  haber            Decimal
  monedaId         BigInt
  empresaId        BigInt
  referenciaExtId  String?
  tipoReferenciaId BigInt?
  estado           String
  fechaEnvio       DateTime?

  movimientoCaja      MovimientoCaja @relation(fields: [movimientoCajaId], references: [id])
}

model Banco {
  id              BigInt            @id @default(autoincrement())
  nombre          String
  codigoSwift     String?
  codigoBcrp      String?
  paisId          BigInt?
  activo          Boolean           @default(true)
  billeteraDigital Boolean @default(false)
  nroBilleteraDigital String?

  cuentas     CuentaCorriente[]
  ctaCteEntidad CtaCteEntidad[]
}

model BolicheRed {
  id                BigInt              @id @default(autoincrement())
  activoId          BigInt              @unique
  descripcion       String?
  cesado            Boolean             @default(false)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime
  altoM             Decimal?
  estadoActivoId    BigInt
  largoContraido    Decimal?
  largoExpandido    Decimal?
  nroFlotadores     Int?
  nroPlomos         Int?
  urlBolicheRedPdf  String?
  paraPescaConsumo  Boolean @default(false)
  paraPescaIndustrial Boolean @default(false)

  faenas FaenaPesca[] @relation("BolicheFaenas")
  faenasConsumo FaenaPescaConsumo[] @relation("BolicheFaenasConsumo")
}

model Cala {
  id                  BigInt               @id @default(autoincrement())
  bahiaId             BigInt
  motoristaId         BigInt
  patronId            BigInt
  embarcacionId       BigInt
  faenaPescaId        BigInt
  fechaHoraInicio     DateTime?
  fechaHoraFin        DateTime?
  latitud             Decimal?
  longitud            Decimal?
  profundidadM        Decimal?
  toneladasCapturadas Decimal?
  observaciones       String?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime
  temporadaPescaId    BigInt

  faenaPesca            FaenaPesca @relation(fields: [faenaPescaId], references: [id])
  especiesPescadas      DetalleCalaEspecie[]
}

model CalaFaenaConsumo {
  id                  BigInt                @id @default(autoincrement())
  bahiaId             BigInt
  motoristaId         BigInt
  patronId            BigInt
  embarcacionId       BigInt
  faenaPescaConsumoId BigInt
  fechaHoraInicio     DateTime?
  fechaHoraFin        DateTime?
  latitud             Decimal?
  longitud            Decimal?
  profundidadM        Decimal?
  toneladasCapturadas Decimal?
  observaciones       String?
  createdAt           DateTime              @default(now())
  updatedAt           DateTime
  novedadPescaConsumoId          BigInt

  faenaPescaConsumo     FaenaPescaConsumo @relation(fields: [faenaPescaConsumoId], references: [id])
  especiesPescadas DetCalaPescaConsumo[]
}

model CargosPersonal {
  id          BigInt     @id @default(autoincrement())
  descripcion String?
  cesado      Boolean    @default(false)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime

  personal    Personal[]
}

model CategoriaCCosto {
  id          BigInt        @id @default(autoincrement())
  nombre      String        @db.VarChar(50)
  descripcion String?
  activo      Boolean       @default(true)

  centros     CentroCosto[]
}

model CentroCosto {
  Codigo             String               @db.VarChar(20)
  Nombre             String               @db.VarChar(255)
  Descripcion        String?
  CategoriaID        BigInt
  ParentCentroID     String?              @db.VarChar(20)
  id                 BigInt               @id @default(autoincrement())

  categoria       CategoriaCCosto @relation(fields: [CategoriaID], references: [id])
  empresasCentro EmpresaCentroCosto[]
  
  entregasARendirVentas         EntregaARendirPVentas[] 
  entregasARendirIndustrial     EntregaARendir[]
  entregasARendirCompras        EntregaARendirPCompras[]
  entregasARendirConsumo        EntregaARendirPescaConsumo[]

  entregasRendirMovAlmacen EntregaARendirMovAlmacen[]
    entregasRendirContratoServicio    EntregaARendirContratoServicios[] @relation("EntregaRendirContratoServicio")
  detallesMovContratoServicio       DetMovsEntregaRendirContratoServicios[] @relation("DetMovContratoServicio")
}

model Color {
  id       BigInt     @id @default(autoincrement())
  nombre   String     @db.VarChar(80)
  productos               Producto[]
}

model ConceptoMovAlmacen {
  id                    BigInt                @id @default(autoincrement())
  descripcion           String                @db.VarChar(100)
  descripcionArmada     String                @db.VarChar(255)
  almacenOrigenId       BigInt?
  almacenDestinoId      BigInt?
  llevaKardexOrigen     Boolean               @default(false)
  llevaKardexDestino    Boolean               @default(false)
  esCustodia            Boolean               @default(false)
  tipoConceptoId        BigInt
  tipoMovimientoId      BigInt
  tipoAlmacenId         BigInt
  activo                Boolean               @default(true)

  movimientos      MovimientoAlmacen[]
  tipoConcepto     TipoConcepto  @relation(fields: [tipoConceptoId], references: [id])
  tipoMovimiento   TipoMovimientoAlmacen @relation(fields: [tipoMovimientoId], references: [id])
  tipoAlmacen      TipoAlmacen   @relation(fields: [tipoAlmacenId], references: [id])
  kardexAlmacenes KardexAlmacen[]
}

model Almacen {
  id                 BigInt           @id @default(autoincrement())
  tipoAlmacenamientoId BigInt
  tipoAlmacenId      BigInt
  nombre             String
  descripcion        String?
  activo             Boolean          @default(true)
  centroAlmacenId    BigInt
  seLlevaKardex      Boolean          @default(false)
  esAlmacenExterno   Boolean          @default(false)
  esAlmacenPropioSede Boolean          @default(false)
  esAlmacenProduccion Boolean          @default(false)


  centroAlmacen CentrosAlmacen @relation(fields: [centroAlmacenId], references: [id])
  tipoAlmacenamiento TipoAlmacenamiento @relation(fields: [tipoAlmacenamientoId], references: [id])
  tipoAlmacen TipoAlmacen @relation(fields: [tipoAlmacenId], references: [id])
  contratosServicio       ContratoServicio[]    @relation("ContratoServicioAlmacen")

}

model CentrosAlmacen {
  id                 BigInt           @id @default(autoincrement())
  nombre             String
  descripcion        String?
  activo             Boolean          @default(true)
  proveedorId        BigInt?
  esCentroExterno    Boolean          @default(false)
  esCentroPropioSede       Boolean          @default(false)
  esCentroProduccion Boolean          @default(false)
  empresaId BigInt

  almacenes Almacen[]

}


// ============================================
// MDULO DE VENTAS - EXPORTACIN
// ============================================
// Gestiona el proceso completo de ventas de exportaci贸n:
// 1. Cotizaci贸n con c谩lculo de costos y factor de exportaci贸n
// 2. Documentaci贸n requerida por pa铆s/producto
// 3. Entrega a rendir para gastos reales
// 4. PreFactura (Nota de Venta)
// ============================================

// ============================================
// 1. INCOTERM (Cat谩logo Maestro)
// ============================================
// Define los t茅rminos internacionales de comercio (FOB, CIF, DDP, etc.)
// y su relaci贸n con las responsabilidades de costos

model Incoterm {
  id                BigInt       @id @default(autoincrement())
  codigo            String       @unique @db.VarChar(10)              // "FOB", "CIF", "DDP"
  nombre            String       @db.VarChar(100)                     // "Free On Board"
  descripcion       String?      @db.Text                             // Descripci贸n detallada
  activo            Boolean      @default(true)
  
  fechaCreacion     DateTime     @default(now())
  fechaActualizacion DateTime?   @updatedAt
  creadoPor         BigInt?
  actualizadoPor    BigInt?

  cotizaciones      CotizacionVentas[]
  preFacturas       PreFactura[]
  costosAplicables  CostoExportacionPorIncoterm[]                    // Costos que aplican seg煤n Incoterm
}

// ============================================
// 2. COSTOS DE EXPORTACIN POR INCOTERM
// ============================================
// Define qu茅 costos aplican para cada Incoterm y qui茅n es responsable
// Ejemplo: En FOB el vendedor paga flete local, en CIF tambi茅n paga flete internacional

model CostoExportacionPorIncoterm {
  id                          BigInt      @id @default(autoincrement())
  incotermId                  BigInt
  productoId                  BigInt                                 // Producto de FamiliaProducto = 7 "Gastos Exportaci贸n"
  esResponsabilidadVendedor   Boolean     @default(true)             // true=VENDEDOR, false=COMPRADOR
  activo                      Boolean     @default(true)             // Para activar/desactivar el costo
  esObligatorio               Boolean     @default(true)
  orden                       Int?                                   // Orden de presentaci贸n
  
  fechaCreacion               DateTime    @default(now())
  fechaActualizacion          DateTime?   @updatedAt
  creadoPor                   BigInt?
  actualizadoPor              BigInt?
  proveedorDefaultId          BigInt?
  monedaDefaultId           BigInt?
  valorVentaDefault           Decimal?
  requiereDocumento           Boolean     @default(false)
  documentoAsociadoId         BigInt?

  proveedorDefault            EntidadComercial? @relation("ProveedorDefaultCostoIncoterm", fields: [proveedorDefaultId], references: [id])
  monedaDefault               Moneda? @relation("MonedaDefaultCostoIncoterm", fields: [monedaDefaultId], references: [id])
  incoterm                    Incoterm @relation(fields: [incotermId], references: [id])
  producto                    Producto @relation(fields: [productoId], references: [id])
  documentoAsociado           DocRequeridaVentas? @relation("CostoIncotermDocumento", fields: [documentoAsociadoId], references: [id])  
  
  @@unique([incotermId, productoId])
  @@index([incotermId])
  @@index([productoId])
}

// ============================================
// 3. COTIZACIN DE VENTAS (Cabecera)
// ============================================
// Documento principal para cotizar exportaciones
// Calcula factor de exportaci贸n y precio final con utilidad

model CotizacionVentas {
  id                          BigInt      @id @default(autoincrement())
  codigo                      String      @unique @db.VarChar(30)
  version                     Int         @default(1)                // Control de versiones
  cotizacionPadreId           BigInt?                                // Para versionado
  
  // Datos del documento
  empresaId                   BigInt
  tipoDocumentoId             BigInt                                 // Valor: 18 (Cotizaci贸n Venta)
  serieDocId                  BigInt
  numeroDocumento             String?     @db.VarChar(40)
  numSerieDoc                 String?     @db.VarChar(40)
  numCorreDoc                 String?     @db.VarChar(40)
  fechaDocumento              DateTime    @default(now())
  fechaVencimiento            DateTime
  
  // Cliente
  clienteId                   BigInt
  contactoClienteId           BigInt?
  dirEntregaId                BigInt?
  dirFiscalId                 BigInt?
  
  // Responsables
  respVentasId                BigInt                                 // Responsable de ventas
  autorizaVentaId             BigInt                                 // Quien autoriza
  supervisorVentaCampoId      BigInt?
  respEmbarqueId              BigInt?
  respProduccionId            BigInt?
  respAlmacenId               BigInt?
  
  // Datos comerciales
  tipoProductoId              BigInt
  formaPagoId                 BigInt
  bancoId                     BigInt?
  monedaId                    BigInt
  tipoCambio                  Decimal     @db.Decimal(18, 6)
  
  // Datos de exportaci贸n
  esExportacion               Boolean     @default(false)
  paisDestinoId               BigInt?
  incotermsId                 BigInt?
  puertoCargaId               BigInt?
  puertoDescargaId            BigInt?
  
  // Log铆stica
  agenteAduanasId             BigInt?
  operadorLogisticoId         BigInt?
  navieraId                   BigInt?
  tipoContenedorId            BigInt?
  cantidadContenedores        Int?
  pesoMaximoContenedor        Decimal?    @db.Decimal(18, 3)
  
  // Fechas log铆sticas
  fechaEntregaEstimada        DateTime
  fechaZarpeEstimada          DateTime?
  fechaArriboEstimada         DateTime?
  diasTransito                Int?
  
  // Impuestos
  porcentajeIGV               Decimal?    @db.Decimal(5, 2)
  esExoneradoAlIGV            Boolean     @default(false)
  
  // C谩lculo de costos y utilidad
  metodoCalculoFactor         String      @db.VarChar(20) @default("PORCENTUAL")  // "PORCENTUAL" o "POR_PESO"
  factorExportacion           Decimal     @db.Decimal(18, 6)         // Factor calculado de costos exportaci贸n
  margenUtilidadPorcentaje    Decimal?    @db.Decimal(5, 2)          // % de utilidad deseada
  
  // Adelantos
  montoAdelantadoCliente      Decimal?    @db.Decimal(18, 2)
  porcentajeAdelanto          Decimal?    @db.Decimal(5, 2)
  
  // Estado y aprobaci贸n
  estadoId                    BigInt
  motivoRechazo               String?     @db.Text
  fechaAprobacion             DateTime?
  aprobadoPorId               BigInt?
  
  // Conversi贸n a PreFactura
  prefacturaVentaId           BigInt?
  fechaConversionPreFactura   DateTime?
  usuarioConversionId         BigInt?
  
  // Campos SUNAT
  destinoProductoId           BigInt?
  formaTransaccionId          BigInt?
  modoDespachoRecepcionId     BigInt?
  tipoEstadoProductoId        BigInt?
  
  observaciones               String?     @db.Text
  observacionesInternas       String?     @db.Text
  urlCotizacionPdf            String?     @db.VarChar(500)
  urlDocumentacionRequeridaPdf String?     @db.VarChar(500)

  centroCostoId               BigInt?
  
  fechaCreacion               DateTime    @default(now())
  fechaActualizacion          DateTime?   @updatedAt
  creadoPor                   BigInt?
  actualizadoPor              BigInt?

  // Relaciones
  empresa                     Empresa                  @relation(fields: [empresaId], references: [id])
  cliente                     EntidadComercial         @relation(fields: [clienteId], references: [id])
  tipoDocumento               TipoDocumento            @relation(fields: [tipoDocumentoId], references: [id])
  moneda                      Moneda                   @relation(fields: [monedaId], references: [id])
  formaPago                   FormaPago                @relation(fields: [formaPagoId], references: [id])
  incoterms                   Incoterm?                @relation(fields: [incotermsId], references: [id])
  serieDoc                    SerieDoc                 @relation(fields: [serieDocId], references: [id])
  estado                      EstadoMultiFuncion       @relation(fields: [estadoId], references: [id])
  
  tipoProducto                TipoProducto             @relation(fields: [tipoProductoId], references: [id])
  tipoEstadoProducto          TipoEstadoProducto?      @relation(fields: [tipoEstadoProductoId], references: [id])
  destinoProducto             DestinoProducto?         @relation(fields: [destinoProductoId], references: [id])
  formaTransaccion            FormaTransaccion?        @relation(fields: [formaTransaccionId], references: [id])
  modoDespachoRecepcion       ModoDespachoRecepcion?   @relation(fields: [modoDespachoRecepcionId], references: [id])
  tipoContenedor              TipoContenedor?          @relation(fields: [tipoContenedorId], references: [id])

  cotizacionPadre             CotizacionVentas?        @relation("VersionesCotizacion", fields: [cotizacionPadreId], references: [id])
  versiones                   CotizacionVentas[]       @relation("VersionesCotizacion")
  
  detallesProductos           DetCotizacionVentas[]
  costosExportacion           CostosExportacionCotizacion[]
  documentosRequeridos        DetDocsReqCotizaVentas[]
  entregaARendir              EntregaARendirPVentas?
  
  @@index([empresaId, fechaDocumento])
  @@index([estadoId])
  @@index([clienteId])
  @@index([codigo])
}

model TipoContenedor {
  id                BigInt       @id @default(autoincrement())
  codigo            String       @unique @db.VarChar(10)              // "FOB", "CIF", "DDP"
  nombre            String       @db.VarChar(100)                     // "Free On Board"
  descripcion       String?      @db.Text                             // Descripci贸n detallada
  activo            Boolean      @default(true)
  
  fechaCreacion     DateTime     @default(now())
  fechaActualizacion DateTime?   @updatedAt
  creadoPor         BigInt?
  actualizadoPor    BigInt?

  cotizaciones      CotizacionVentas[]
  preFacturas       PreFactura[]
}

// ============================================
// 4. DETALLE DE PRODUCTOS (Cotizaci贸n)
// ============================================
// Productos cotizados con c谩lculo de precios
// precioUnitario = costoUnitario  factorExportacion
// precioUnitarioFinal = precioUnitario  (1 + margenUtilidad)

model DetCotizacionVentas {
  id                          BigInt      @id @default(autoincrement())
  cotizacionVentasId          BigInt
  item                        Int
  productoId                  BigInt
  descripcionAdicional        String?     @db.Text
  
  cantidad                    Decimal     @db.Decimal(18, 3)
  pesoNeto                    Decimal?    @db.Decimal(18, 3)         // Para m茅todo POR_PESO
  
  // C谩lculo de precios
  costoUnitarioEstimado       Decimal?    @db.Decimal(18, 6)         // Costo base del producto
  factorExportacionAplicado   Decimal?    @db.Decimal(18, 6)         // Factor aplicado
  precioUnitario              Decimal     @db.Decimal(18, 6)         // = costo  factor

  //  AGREGAR: Trazabilidad de precio especial (PrecioEntidad)
  precioEntidadId             BigInt?                                 // FK a PrecioEntidad (nullable)
  precioEntidadOriginal       Decimal?    @db.Decimal(18, 6)         // Precio que se jal贸 de PrecioEntidad (hist贸rico)
  precioFueEditado            Boolean     @default(false)             // true si usuario modific贸 el precio especial
  
  //  AGREGAR: M谩rgenes de utilidad (copiados del producto, editables en cotizaci贸n)
  margenMinimoPermitido       Decimal?    @db.Decimal(5, 2)          // % m铆nimo de margen
  margenUtilidadObjetivo      Decimal?    @db.Decimal(5, 2)          // % objetivo de margen
  margenUtilidadReal          Decimal?    @db.Decimal(5, 2)          // % real calculado: ((precioFinal - precioUnitario) / precioFinal)  100

  precioUnitarioFinal         Decimal     @db.Decimal(18, 6)         // = precioUnitario  (1 + margen)
  
  // Trazabilidad de producci贸n
  loteProduccion              String?     @db.VarChar(50)
  fechaProduccion             DateTime?
  fechaVencimiento            DateTime?
  temperaturaAlmacenamiento   String?     @db.VarChar(50)
  
  movSalidaAlmacenId          BigInt?
  observaciones               String?     @db.Text
  centroCostoId               BigInt
  
  fechaCreacion               DateTime    @default(now())
  fechaActualizacion          DateTime?   @updatedAt
  creadoPor                   BigInt?
  actualizadoPor              BigInt?

  cotizacionVentas            CotizacionVentas @relation(fields: [cotizacionVentasId], references: [id], onDelete: Cascade)
  producto                    Producto @relation(fields: [productoId], references: [id])
    //  AGREGAR: Relaci贸n con PrecioEntidad (nullable)
  precioEntidad               PrecioEntidad? @relation(fields: [precioEntidadId], references: [id])


  @@index([cotizacionVentasId])
  @@index([productoId])
  //  AGREGAR: ndice para b煤squedas por precio especial
  @@index([precioEntidadId])
}

// ============================================
// 5. COSTOS DE EXPORTACIN (Detalle por Cotizaci贸n)
// ============================================
// Costos estimados y reales de exportaci贸n
// Permite calcular factor y comparar estimado vs real

model CostosExportacionCotizacion {
  id                          BigInt      @id @default(autoincrement())
  cotizacionVentasId          BigInt
  productoId                  BigInt                                 // Producto de Familia "Gastos Exportaci贸n"  
  // ESTIMADO (al cotizar)
  montoEstimado               Decimal     @db.Decimal(18, 2)
  monedaId                    BigInt
  tipoCambioAplicado          Decimal?    @db.Decimal(18, 6)
  montoEstimadoMonedaBase     Decimal     @db.Decimal(18, 2)         // Convertido a moneda de cotizaci贸n
  
  // REAL (despu茅s de exportar)
  montoReal                   Decimal?    @db.Decimal(18, 2)
  montoRealMonedaBase         Decimal?    @db.Decimal(18, 2)
  variacionMonto              Decimal?    @db.Decimal(18, 2)         // Real - Estimado
  variacionPorcentaje         Decimal?    @db.Decimal(5, 2)          // % de variaci贸n
  movimientoEntregaRendirId   BigInt?                                // Vincula con gasto real
  
  aplicaSegunIncoterm         Boolean     @default(true)
  proveedorId                 BigInt?
  requiereDocumento           Boolean     @default(false)
  documentoAsociadoId         BigInt?
  esObligatorio               Boolean     @default(true)
  orden                       Int
  
  fechaCreacion               DateTime    @default(now())
  fechaActualizacion          DateTime?   @updatedAt
  creadoPor                   BigInt?
  actualizadoPor              BigInt?

  cotizacionVentas            CotizacionVentas @relation(fields: [cotizacionVentasId], references: [id], onDelete: Cascade)
  producto                    Producto @relation("CostoExportacionProducto", fields: [productoId], references: [id])
  moneda                      Moneda @relation(fields: [monedaId], references: [id])
  proveedor                   EntidadComercial? @relation("ProveedorCostoExport", fields: [proveedorId], references: [id])
  movimientoEntregaRendir     DetMovsEntregaRendirPVentas? @relation(fields: [movimientoEntregaRendirId], references: [id])
  documentoAsociado           DocRequeridaVentas? @relation("CostoExportacionDocumento", fields: [documentoAsociadoId], references: [id])

  @@index([cotizacionVentasId])
  @@index([productoId])
  @@index([movimientoEntregaRendirId])
}

// ============================================
// 6. DOCUMENTOS REQUERIDOS (Detalle por Cotizaci贸n)
// ============================================
// Documentos espec铆ficos requeridos para esta cotizaci贸n
// con seguimiento de estado y vencimientos

model DetDocsReqCotizaVentas {
  id                          BigInt      @id @default(autoincrement())
  cotizacionVentasId          BigInt
  docRequeridaVentasId        BigInt
  esObligatorio               Boolean     @default(true)
  numeroDocumento             String?     @db.VarChar(100)
  fechaEmision                DateTime?
  fechaVencimiento            DateTime?
  urlDocumento                String?     @db.VarChar(500)
  verificado                  Boolean     @default(false)
  fechaVerificacion           DateTime?
  verificadoPorId             BigInt?
  observacionesVerificacion   String?     @db.Text
  costoDocumento              Decimal?    @db.Decimal(18, 2)
  monedaId                    BigInt?
  fechaCreacion               DateTime    @default(now())
  fechaActualizacion          DateTime?   @updatedAt
  creadoPor                   BigInt?
  actualizadoPor              BigInt?

  cotizacionVentas            CotizacionVentas @relation(fields: [cotizacionVentasId], references: [id], onDelete: Cascade)
  docRequeridaVentas          DocRequeridaVentas @relation(fields: [docRequeridaVentasId], references: [id])
  moneda                      Moneda? @relation("MonedaDetDocsReqCotizaVentas", fields: [monedaId], references: [id])

  @@index([cotizacionVentasId])
}

// ============================================
// 7. CATLOGO DE DOCUMENTOS REQUERIDOS
// ============================================
// Cat谩logo maestro de documentos para exportaci贸n
// Define qu茅 documentos existen y sus caracter铆sticas

model DocRequeridaVentas {
  id                          BigInt      @id @default(autoincrement())
  nombre                      String      @db.VarChar(255)           // "Certificado Sanitario SANIPES"
  descripcion                 String?     @db.Text
  
  // Reglas de aplicabilidad
  aplicaPorPais               Boolean     @default(false)            // 驴Var铆a seg煤n pa铆s destino?
  aplicaPorProducto           Boolean     @default(false)            // 驴Var铆a seg煤n tipo producto?
  aplicaPorIncoterm           Boolean     @default(false)            // 驴Var铆a seg煤n Incoterm?
  esObligatorioPorDefecto     Boolean     @default(true)
  
  // Vigencia
  tieneVencimiento            Boolean     @default(false)
  diasValidez                 Int?                                   // D铆as de validez del documento
  
  // Costo
  costoEstimado               Decimal?    @db.Decimal(18, 2)
  monedaId                    BigInt?
  
  activo                      Boolean     @default(true)
  fechaCreacion               DateTime    @default(now())
  fechaActualizacion          DateTime?   @updatedAt
  creadoPor                   BigInt?
  actualizadoPor              BigInt?

  moneda                      Moneda? @relation(fields: [monedaId], references: [id])
  documentosRequeridos        DetDocsReqCotizaVentas[]
  requisitosPorPais           RequisitoDocPorPais[]
  costosCotizacionAsociados   CostosExportacionCotizacion[] @relation("CostoExportacionDocumento")
  costosIncotermAsociados     CostoExportacionPorIncoterm[] @relation("CostoIncotermDocumento")
}

// ============================================
// 8. REQUISITOS DE DOCUMENTOS POR PAS
// ============================================
// Define qu茅 documentos son obligatorios para cada pa铆s/producto
// Ejemplo: China + Langostinos = Certificado Sanitario obligatorio

model RequisitoDocPorPais {
  id                          BigInt      @id @default(autoincrement())
  docRequeridaVentasId        BigInt
  paisId                      BigInt
  tipoProductoId              BigInt?                                // NULL = aplica a todos los productos
  esObligatorio               Boolean     @default(true)
  observaciones               String?     @db.Text
  fechaCreacion               DateTime    @default(now())
  fechaActualizacion          DateTime?   @updatedAt
  creadoPor                   BigInt?
  actualizadoPor              BigInt?

  docRequeridaVentas          DocRequeridaVentas @relation(fields: [docRequeridaVentasId], references: [id])
  pais                        Pais @relation(fields: [paisId], references: [id])
  tipoProducto                TipoProducto? @relation(fields: [tipoProductoId], references: [id])
  
  @@unique([docRequeridaVentasId, paisId, tipoProductoId])
}

// ============================================
// 9. ENTREGA A RENDIR PROCESO DE VENTAS
// ============================================
// Control de dinero entregado para gastos de exportaci贸n
// Totales se calculan desde DetMovsEntregaRendirPVentas
model EntregaARendirPVentas {
  id                          BigInt      @id @default(autoincrement())
  cotizacionVentasId          BigInt      @unique
  respEntregaRendirId         BigInt                                 // Personal responsable
  entregaLiquidada            Boolean     @default(false)
  fechaLiquidacion            DateTime?
  centroCostoId               BigInt
  fechaCreacion               DateTime    @default(now())
  fechaActualizacion          DateTime?   @updatedAt
  creadoPor                   BigInt?
  actualizadoPor              BigInt?
  urlLiquidacionPdf String?
  respLiquidacionId BigInt?

  cotizacionVentas            CotizacionVentas @relation(fields: [cotizacionVentasId], references: [id])
  movimientos                 DetMovsEntregaRendirPVentas[]
  respLiquidacion Personal? @relation("LiquidadorVentas", fields: [respLiquidacionId], references: [id])
  respEntregaRendir Personal @relation("ResponsableEntregaVentas", fields: [respEntregaRendirId], references: [id])
  centroCosto CentroCosto @relation(fields: [centroCostoId], references: [id])
  
  @@index([cotizacionVentasId])
  @@index([respEntregaRendirId])
  @@index([entregaLiquidada])
}

// ============================================
// 10. DETALLE MOVIMIENTOS ENTREGA A RENDIR
// ============================================
// Registro de gastos reales de exportaci贸n
// Se vincula con CostosExportacionCotizacion para comparar estimado vs real

model DetMovsEntregaRendirPVentas {
  id                          BigInt      @id @default(autoincrement())
  entregaARendirPVentasId     BigInt
  responsableId               BigInt
  fechaMovimiento             DateTime
  tipoMovimientoId            BigInt                                 // ENTREGA_INICIAL, GASTO, DEVOLUCION, AMPLIACION
  productoId                  BigInt?                                // Producto de Familia "Gastos Exportaci贸n"
  monto                       Decimal     @db.Decimal(18, 2)
  descripcion                 String?     @db.Text
  monedaId                    BigInt
  tipoCambio                  Decimal?    @db.Decimal(18, 6)
  entidadComercialId          BigInt?                                // Proveedor al que se pag贸
  
  // Comprobante
  tipoDocumentoId             BigInt?
  numeroSerieComprobante      String?     @db.VarChar(20)
  numeroCorrelativoComprobante String?    @db.VarChar(20)
  urlComprobanteMovimiento    String?     @db.VarChar(500)
  
  // Validaciones
  operacionSinFactura         Boolean     @default(false)
  validadoTesoreria           Boolean     @default(false)
  fechaValidacionTesoreria    DateTime?
  validadoPorId               BigInt?
  
  // Integraci贸n con Caja
  operacionMovCajaId          BigInt?
  fechaOperacionMovCaja       DateTime?
  urlComprobanteOperacionMovCaja String?  @db.VarChar(500)
  moduloOrigenMovCajaId       BigInt?
  
  centroCostoId               BigInt
  fechaCreacion               DateTime    @default(now())
  fechaActualizacion          DateTime?   @updatedAt
  creadoPor                   BigInt?
  actualizadoPor              BigInt?

  entregaARendirPVentas       EntregaARendirPVentas @relation(fields: [entregaARendirPVentasId], references: [id], onDelete: Cascade)
  tipoMovimiento              TipoMovEntregaRendir @relation(fields: [tipoMovimientoId], references: [id])
  producto                    Producto? @relation("MovimientoGastoExportacion", fields: [productoId], references: [id])
  entidadComercial            EntidadComercial? @relation("ProveedorMovPVentas", fields: [entidadComercialId], references: [id])
  moneda                      Moneda @relation(fields: [monedaId], references: [id])
  tipoDocumento               TipoDocumento? @relation(fields: [tipoDocumentoId], references: [id])
  
  costosEstimadosVinculados   CostosExportacionCotizacion[]          // Relaci贸n inversa para vincular con estimados
  
  @@index([entregaARendirPVentasId])
  @@index([productoId])
}

// ============================================
// 11. PREFACTURA (NOTA DE VENTA)
// ============================================
// Documento previo a la factura definitiva
// Se genera desde una cotizaci贸n aprobada
// Totales se calculan desde DetallePreFactura

model PreFactura {
  id                           BigInt      @id @default(autoincrement())
  codigo                       String      @unique @db.VarChar(30)
  empresaId                    BigInt
  clienteId                    BigInt
  tipoDocumentoId              BigInt
  serieDocId                   BigInt
  numeroDocumento              String?     @db.VarChar(40)
  numSerieDoc                 String?     @db.VarChar(40)
  numCorreDoc                 String?     @db.VarChar(40)
  fechaDocumento               DateTime    @default(now())
  cotizacionVentasOrigenId     BigInt?                               // Cotizaci贸n que origin贸 esta PreFactura
  ordenCompraCliente           String?     @db.VarChar(100)
  movSalidaAlmacenId           BigInt?
  
  // Datos de exportaci贸n
  esExportacion                Boolean     @default(false)
  paisDestinoId                BigInt?
  puertoCargaId                BigInt?
  puertoDescargaId             BigInt?
  incotermId                   BigInt?
  agenteAduanaId               BigInt?
  bancoId                      BigInt?
  numeroBuque                  String?     @db.VarChar(100)
  numeroBL                     String?     @db.VarChar(100)          // Bill of Lading
  numContenedor                String?     @db.VarChar(100)
  tipoContenedorId             BigInt?
  
  // Impuestos
  exoneradoIgv                 Boolean     @default(false)
  porcentajeIgv                Decimal?    @db.Decimal(5, 2)
  
  formaPagoId                  BigInt
  fechaVencimiento             DateTime?
  estadoId                     BigInt
  monedaId                     BigInt?
  tipoCambio                   Decimal?    @db.Decimal(18, 6)
  
  // Factores de exportaci贸n
  factorExportacion            Decimal?    @db.Decimal(18, 6)        // Factor estimado (de cotizaci贸n)
  factorExportacionReal        Decimal?    @db.Decimal(18, 6)        // Factor real (despu茅s de exportar)
  
  observaciones                String?     @db.Text
  urlPreFacturaPdf             String?     @db.VarChar(500)
  
  // Transferencia a ERP Contable
  fechaTransfErpContable       DateTime?
  numIdTransfErpContable       String?     @db.VarChar(100)
  personaRespTransfErpContable BigInt?
  
  centroCostoId                BigInt?
  dirEntregaId                 BigInt?
  dirFiscalId                  BigInt?
  contratoServicioId       BigInt?

  fechaCreacion                DateTime    @default(now())
  fechaActualizacion           DateTime?   @updatedAt
  creadoPor                    BigInt?
  actualizadoPor               BigInt?

  empresa                      Empresa @relation(fields: [empresaId], references: [id])
  cliente                      EntidadComercial @relation("ClientePreFactura", fields: [clienteId], references: [id])
  tipoDocumento                TipoDocumento @relation(fields: [tipoDocumentoId], references: [id])
  moneda                       Moneda? @relation(fields: [monedaId], references: [id])
  incoterm                     Incoterm? @relation(fields: [incotermId], references: [id])
  serieDoc                     SerieDoc @relation(fields: [serieDocId], references: [id])
  formaPago                    FormaPago @relation(fields: [formaPagoId], references: [id])
  tipoContenedor               TipoContenedor? @relation(fields: [tipoContenedorId], references: [id])
  movSalidaAlmacen             MovimientoAlmacen? @relation("MovimientoAlmacenToPreFactura", fields: [movSalidaAlmacenId], references: [id])
  detalles                     DetallePreFactura[]
  contratoServicio        ContratoServicio?     @relation("PreFacturaContrato", fields: [contratoServicioId], references: [id])

  @@index([empresaId, fechaDocumento])
  @@index([clienteId])
}

// ============================================
// 12. DETALLE DE PREFACTURA
// ============================================
// Productos incluidos en la PreFactura
// Subtotales se calculan en runtime (cantidad  precioUnitario)

model DetallePreFactura {
  id                          BigInt      @id @default(autoincrement())
  preFacturaId                BigInt
  productoId                  BigInt
  cantidad                    Decimal     @db.Decimal(18, 3)
  precioUnitario              Decimal?    @db.Decimal(18, 6)
  centroCostoId               BigInt?
  fechaCreacion               DateTime    @default(now())
  fechaActualizacion          DateTime?   @updatedAt
  creadoPor                   BigInt?
  actualizadoPor              BigInt?

  preFactura                  PreFactura @relation(fields: [preFacturaId], references: [id], onDelete: Cascade)
  producto                    Producto @relation(fields: [productoId], references: [id])
  
  @@index([preFacturaId])
}


model CuentaCorriente {
  id                                                                      BigInt              @id @default(autoincrement())
  empresaId                                                               BigInt
  bancoId                                                                 BigInt
  numeroCuenta                                                            String
  tipoCuentaCorrienteId                                                   BigInt
  monedaId                                                                BigInt
  descripcion                                                             String?
  activa                                                                  Boolean             @default(true)
  codigoSwift                                                             String?
  numeroCuentaCCI                                                         String?

  banco                  Banco    @relation(fields: [bancoId], references: [id])
  tipoCuentaCorriente    TipoCuentaCorriente @relation(fields: [tipoCuentaCorrienteId], references: [id])
  moneda                 Moneda   @relation(fields: [monedaId], references: [id])
  movimientosOrigen      MovimientoCaja[] @relation("CuentaCorrienteOrigen")
  movimientosDestino     MovimientoCaja[] @relation("CuentaCorrienteDestino")

    @@unique([numeroCuenta, bancoId, empresaId], name: "unique_cuenta_banco_empresa")

}

model Departamento {
  id        BigInt      @id @default(autoincrement())
  codSUNAT  String      @unique
  nombre    String
  paisId    BigInt

  pais       Pais     @relation(fields: [paisId], references: [id])
  provincias Provincia[]
  ubigeos    Ubigeo[]
}

model DescargaFaenaConsumo {
  id                           BigInt                    @id @default(autoincrement())
  faenaPescaConsumoId          BigInt                    @unique
  puertoDescargaId             BigInt?
  fechaHoraArriboPuerto        DateTime?
  fechaHoraLlegadaPuerto       DateTime?
  clienteId                    BigInt?
  numPlataformaDescarga        String?                   @db.VarChar(20)
  turnoPlataformaDescarga      String?                   @db.VarChar(20)
  fechaHoraInicioDescarga      DateTime?
  fechaHoraFinDescarga         DateTime?
  numWinchaPesaje              String?                   @db.VarChar(20)
  urlComprobanteWincha         String?
  patronId                      BigInt
  motoristaId                  BigInt
  bahiaId                      BigInt
  latitud                      Decimal?
  longitud                     Decimal?
  combustibleAbastecidoGalones Decimal?
  urlValeAbastecimiento        String?
  urlInformeDescargaProduce    String?
  observaciones                String?
  creadoEn                     DateTime                  @default(now())
  actualizadoEn                DateTime
  movIngresoAlmacenId          BigInt?
  especieId              BigInt?
  toneladas              Decimal?
  porcentajeJuveniles    Decimal?
  fechaHoraFondeo     DateTime?
  latitudFondeo       Decimal?
  longitudFondeo      Decimal?
  puertoFondeoId      BigInt?

  faenaPescaConsumo            FaenaPescaConsumo @relation(fields: [faenaPescaConsumoId], references: [id])

  @@index([movIngresoAlmacenId])
}



model DescargaFaenaPesca {
  id                           BigInt                 @id @default(autoincrement())
  faenaPescaId                 BigInt                 @unique
  puertoDescargaId             BigInt?
  fechaHoraArriboPuerto        DateTime?
  fechaHoraLlegadaPuerto       DateTime?
  numPlataformaDescarga        String?                @db.VarChar(20)
  turnoPlataformaDescarga      String?                @db.VarChar(20)
  fechaHoraInicioDescarga      DateTime?
  fechaHoraFinDescarga         DateTime?
  numWinchaPesaje              String?                @db.VarChar(20)
  urlComprobanteWincha         String?
  patronId                      BigInt
  motoristaId                  BigInt
  bahiaId                      BigInt
  latitud                      Decimal?
  longitud                     Decimal?
  combustibleAbastecidoGalones Decimal?
  urlValeAbastecimiento        String?
  observaciones                String?
  creadoEn                     DateTime               @default(now())
  actualizadoEn                DateTime
  clienteId                    BigInt?
  temporadaPescaId             BigInt
  urlInformeDescargaProduce    String?
  movIngresoAlmacenId          BigInt?
  especieId           BigInt?
  toneladas           Decimal?
  porcentajeJuveniles Decimal?
  numReporteRecepcion String? @db.VarChar(20)
  fechaHoraFondeo     DateTime?
  latitudFondeo       Decimal?
  longitudFondeo      Decimal?
  puertoFondeoId      BigInt?

faenaPesca FaenaPesca @relation(fields: [faenaPescaId], references: [id])

  @@index([movIngresoAlmacenId])
}


model DetAccionesPreviasFaena {
  id                   BigInt               @id @default(autoincrement())
  faenaPescaId         BigInt
  accionPreviaId       BigInt
  responsableId        BigInt?
  verificadorId        BigInt?
  fechaVerificacion    DateTime?
  cumplida             Boolean              @default(false)
  fechaCumplida        DateTime?
  observaciones        String?
  verificado           Boolean              @default(false)
  createdAt            DateTime             @default(now())
  updatedAt            DateTime
  urlConfirmaAccionPdf String?

  faenaPesca        FaenaPesca @relation(fields: [faenaPescaId], references: [id])
  accionPrevia      AccionesPreviasFaena @relation(fields: [accionPreviaId], references: [id])
}

model DetAccionesPreviasFaenaConsumo {
  id                   BigInt               @id @default(autoincrement())
  faenaPescaConsumoId  BigInt
  accionPreviaId       BigInt
  responsableId        BigInt?
  verificadorId        BigInt?
  fechaVerificacion    DateTime?
  cumplida             Boolean              @default(false)
  fechaCumplida        DateTime?
  urlConfirmaAccionPdf String?
  observaciones        String?
  verificado           Boolean              @default(false)
  createdAt            DateTime             @default(now())
  updatedAt            DateTime

  faenaPescaConsumo    FaenaPescaConsumo     @relation(fields: [faenaPescaConsumoId], references: [id])
  accionPrevia         AccionesPreviasFaena  @relation(fields: [accionPreviaId], references: [id])
}

model DetCalaPescaConsumo {
  id                  BigInt           @id @default(autoincrement())
  calaFaenaConsumoId  BigInt
  especieId           BigInt
  toneladas           Decimal?
  porcentajeJuveniles Decimal?
  observaciones       String?
  createdAt           DateTime         @default(now())
  updatedAt           DateTime

  calaFaenaConsumo    CalaFaenaConsumo @relation(fields: [calaFaenaConsumoId], references: [id])
  especie             Especie @relation(fields: [especieId], references: [id])
}

model DetDocEmbarcacionPescaConsumo {
  id                  BigInt            @id @default(autoincrement())
  faenaPescaConsumoId BigInt
  documentoPescaId    BigInt
  numeroDocumento     String?
  fechaEmision        DateTime?
  fechaVencimiento    DateTime?
  urlDocEmbarcacion    String?
  observaciones       String?
  verificado          Boolean
  createdAt           DateTime          @default(now())
  updatedAt           DateTime
  docVencido  Boolean @default(false)

  faenaPescaConsumo FaenaPescaConsumo @relation(fields: [faenaPescaConsumoId], references: [id])
}

model DetDocTripulantesFaenaConsumo {
  id                  BigInt            @id @default(autoincrement())
  faenaPescaConsumoId BigInt
  tripulanteId        BigInt?
  documentoId         BigInt?
  numeroDocumento     String?
  fechaEmision        DateTime?
  fechaVencimiento    DateTime?
  urlDocTripulantePdf String?
  observaciones       String?
  verificado          Boolean
  createdAt           DateTime          @default(now())
  updatedAt           DateTime
  docVencido          Boolean             @default(false)

  faenaPescaConsumo    FaenaPescaConsumo @relation(fields: [faenaPescaConsumoId], references: [id])
}

model DetMovsEntRendirPescaConsumo {
  id                           BigInt                     @id @default(autoincrement())
  entregaARendirPescaConsumoId BigInt
  responsableId                BigInt
  fechaMovimiento              DateTime
  tipoMovimientoId             BigInt
  productoId                   BigInt?
  centroCostoId                BigInt
  monto                        Decimal
  descripcion                  String?
  creadoEn                     DateTime                   @default(now())
  actualizadoEn                DateTime
  urlComprobanteMovimiento String?
  validadoTesoreria    Boolean @default(false)
  fechaValidacionTesoreria DateTime?
  operacionSinFactura  Boolean @default(false)
  fechaOperacionMovCaja DateTime?
  operacionMovCajaId BigInt?
  moduloOrigenMovCajaId BigInt?
  entidadComercialId BigInt?
  monedaId BigInt?
  urlComprobanteOperacionMovCaja String?

  tipoDocumentoId        BigInt?                                     // Factura, Boleta, Recibo, Ticket, Sin Comprobante
  numeroSerieComprobante        String?                              // N煤mero Serie del comprobante
  numeroCorrelativoComprobante String?                               // N煤mero Correlativo del comprobante

  entregaARendirPescaConsumo EntregaARendirPescaConsumo @relation(fields: [entregaARendirPescaConsumoId], references: [id])
  tipoMovimiento        TipoMovEntregaRendir @relation(fields: [tipoMovimientoId], references: [id])
  entidadComercial EntidadComercial? @relation(fields: [entidadComercialId], references: [id])
  moneda Moneda? @relation(fields: [monedaId], references: [id])
  tipoDocumento TipoDocumento? @relation(fields: [tipoDocumentoId], references: [id])
  producto Producto? @relation(fields: [productoId], references: [id])
}

model DetMovsEntregaRendir {
  id                   BigInt               @id @default(autoincrement())
  entregaARendirId     BigInt
  responsableId        BigInt
  fechaMovimiento      DateTime
  tipoMovimientoId     BigInt
  productoId           BigInt?
  monto                Decimal
  descripcion          String?
  creadoEn             DateTime             @default(now())
  actualizadoEn        DateTime
  centroCostoId        BigInt
  urlComprobanteMovimiento String?
  validadoTesoreria    Boolean @default(false)
  fechaValidacionTesoreria DateTime?
  operacionSinFactura  Boolean @default(false)
  fechaOperacionMovCaja DateTime?
  operacionMovCajaId BigInt?
  moduloOrigenMovCajaId BigInt?
  entidadComercialId BigInt?
  monedaId BigInt?
  urlComprobanteOperacionMovCaja String?

  tipoDocumentoId        BigInt?                                     // Factura, Boleta, Recibo, Ticket, Sin Comprobante
  numeroSerieComprobante        String?                              // N煤mero Serie del comprobante
  numeroCorrelativoComprobante String?                               // N煤mero Correlativo del comprobante

  entregaARendir        EntregaARendir @relation(fields: [entregaARendirId], references: [id])
  tipoMovimiento        TipoMovEntregaRendir @relation(fields: [tipoMovimientoId], references: [id])
  entidadComercial EntidadComercial? @relation(fields: [entidadComercialId], references: [id])
  moneda Moneda? @relation(fields: [monedaId], references: [id])
  tipoDocumento TipoDocumento? @relation(fields: [tipoDocumentoId], references: [id])
  producto Producto? @relation(fields: [productoId], references: [id])
}

model DetMovsEntregaRendirPCompras {
  id                       BigInt      @id @default(autoincrement())
  entregaARendirPComprasId BigInt                                      // Entrega a rendir a la que pertenece
  tipoMovimientoId         BigInt                                      // 1=Entrega Inicial, 2=Gasto, 3=Devoluci贸n, 4=Ampliaci贸n
  productoId               BigInt?                                     // Producto que se movi贸
  responsableId            BigInt                                      // Personal que realiz贸 el movimiento
  fechaMovimiento          DateTime                                    // Fecha del movimiento
  monto                    Decimal                                     // Monto del movimiento (positivo o negativo seg煤n tipo)
  monedaId                 BigInt?                                     // Moneda del movimiento (PEN, USD)
  descripcion              String?     @db.Text                        // Descripci贸n detallada del movimiento
  entidadComercialId       BigInt?                                     // Proveedor o tercero al que se le pag贸
  
  tipoDocumentoId        BigInt?                                     // Factura, Boleta, Recibo, Ticket, Sin Comprobante
  numeroSerieComprobante        String?                              // N煤mero Serie del comprobante
  numeroCorrelativoComprobante String?                               // N煤mero Correlativo del comprobante

  urlComprobanteMovimiento String?                                     // URL del comprobante escaneado/fotografiado
  validadoTesoreria        Boolean     @default(false)                 // Si tesorer铆a valid贸 el movimiento
  fechaValidacionTesoreria DateTime?                                   // Cu谩ndo se valid贸
  operacionSinFactura      Boolean     @default(false)                 // Si no hay comprobante formal
  motivoSinFactura         String?     @db.Text                        // Por qu茅 no hay comprobante (compra informal, etc.)
  operacionMovCajaId       BigInt?                                     // Si se registr贸 en movimiento de caja
  fechaOperacionMovCaja    DateTime?                                   // Fecha del movimiento de caja
  urlComprobanteOperacionMovCaja String?                               // Comprobante del movimiento de caja
  moduloOrigenMovCajaId    BigInt?                                     // M贸dulo que origin贸 el movimiento (Compras, Ventas, etc.)
  centroCostoId            BigInt                                      // Centro de costo del movimiento
  creadoEn                 DateTime    @default(now())
  actualizadoEn            DateTime    @updatedAt
  
  entregaARendirPCompras   EntregaARendirPCompras @relation(fields: [entregaARendirPComprasId], references: [id], onDelete: Cascade)
  tipoMovimiento           TipoMovEntregaRendir @relation(fields: [tipoMovimientoId], references: [id])
  entidadComercial         EntidadComercial? @relation(fields: [entidadComercialId], references: [id])
  moneda Moneda? @relation(fields: [monedaId], references: [id])
  tipoDocumento TipoDocumento? @relation(fields: [tipoDocumentoId], references: [id])
  producto Producto? @relation(fields: [productoId], references: [id])
}

model DetPermisoGestionadoOT {
  id                       BigInt              @id @default(autoincrement())
  otMantenimientoId        BigInt
  permisoAutorizacionId    BigInt              //  CORREGIR: agregar la 'o' faltante
  gestionado               Boolean             @default(false)
  fechaGestion             DateTime?
  urlPermisoAutorizacion   String?

  otMantenimiento          OTMantenimiento     @relation(fields: [otMantenimientoId], references: [id])
  permisoAutorizacion      PermisoAutorizacion @relation(fields: [permisoAutorizacionId], references: [id])
}


model DetalleCalaEspecie {
  id                  BigInt   @id @default(autoincrement())
  calaId              BigInt
  especieId           BigInt
  toneladas           Decimal?
  porcentajeJuveniles Decimal?
  observaciones       String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime

  cala                Cala   @relation(fields: [calaId], references: [id])
  especie             Especie @relation(fields: [especieId], references: [id])
}



model Especie {
  id BigInt @id @default(autoincrement())
  nombre String @db.VarChar(100)
  nombreCientifico String @db.VarChar(100)

  calaEspecie DetalleCalaEspecie[]
  calaFaenaConsumo DetCalaPescaConsumo[]
}




model DetalleDocEmbarcacion {
  id               BigInt     @id @default(autoincrement())
  faenaPescaId     BigInt
  documentoPescaId BigInt
  numeroDocumento  String?
  fechaEmision     DateTime?
  fechaVencimiento DateTime?
  observaciones    String?
  verificado       Boolean
  createdAt        DateTime   @default(now())
  updatedAt        DateTime
  urlDocEmbarcacion String?
  docVencido  Boolean @default(false)

  faenaPesca       FaenaPesca     @relation(fields: [faenaPescaId], references: [id])
}

model DetalleDocTripulantes {
  id                  BigInt     @id @default(autoincrement())
  faenaPescaId        BigInt
  tripulanteId        BigInt?
  documentoId         BigInt?
  numeroDocumento     String?
  fechaEmision        DateTime?
  fechaVencimiento    DateTime?
  observaciones       String?
  verificado          Boolean
  createdAt           DateTime   @default(now())
  updatedAt           DateTime
  urlDocTripulantePdf String?
  docVencido Boolean @default(false)

  faenaPesca     FaenaPesca @relation(fields: [faenaPescaId], references: [id])
}

model DetalleMovimientoAlmacen {
  id                  BigInt            @id @default(autoincrement())
  movimientoAlmacenId BigInt
  productoId          BigInt
  cantidad            Decimal
  peso            Decimal?
  lote                String?           @db.VarChar(40)
  fechaProduccion     DateTime?
  fechaVencimiento    DateTime?
  fechaIngreso        DateTime?
  nroSerie            String?           @db.VarChar(40)
  nroContenedor       String?           @db.VarChar(40)
  estadoMercaderiaId  BigInt?
  estadoCalidadId     BigInt?
  entidadComercialId  BigInt?
  esCustodia          Boolean           @default(false)
  empresaId           BigInt
  observaciones       String?
  creadoEn            DateTime          @default(now())
  actualizadoEn       DateTime
  creadoPor           BigInt?
  actualizadoPor      BigInt?
  detalleReqCompraId  BigInt?
  costoUnitario       Decimal?

  movimientoAlmacen     MovimientoAlmacen  @relation(fields: [movimientoAlmacenId], references: [id])
  producto              Producto @relation(fields: [productoId], references: [id])
  detalleReqCompra      DetalleReqCompra? @relation(fields: [detalleReqCompraId], references: [id])
  insumosOT  DetInsumosTareaOT[] @relation("DetMovAlmacenInsumoOT")

}

model DetalleOrdenCompra {
  id             BigInt      @id @default(autoincrement())
  ordenCompraId  BigInt                                         // Orden a la que pertenece
  productoId     BigInt                                         // Producto a comprar
  cantidad       Decimal                                        // Cantidad ordenada
  cantidadRecibida Decimal?  @default(0)                        // Cantidad realmente recibida
  precioUnitario Decimal                                        // Precio por unidad
  subtotal Decimal?                                             // cantidad * precioUnitario
  centroCostoId  BigInt?                                        // Centro de costo espec铆fico
  observaciones  String?     @db.Text                           // Notas del item
  creadoEn       DateTime    @default(now())
  actualizadoEn  DateTime    @updatedAt
  
  ordenCompra    OrdenCompra @relation(fields: [ordenCompraId], references: [id], onDelete: Cascade)
  producto       Producto @relation(fields: [productoId], references: [id])
  insumosOT  DetInsumosTareaOT[] @relation("DetOCInsumoOT")

  @@index([ordenCompraId])
  @@index([productoId])
}

model RequerimientoCompra {
  id                    BigInt      @id @default(autoincrement())
  empresaId             BigInt                                  // Empresa que solicita la compra
  tipoDocumentoId       BigInt                                  // Tipo de documento (Se asigna el ID 16("REQUERIMIENTO COMPRAS"))
  serieDocId               BigInt?
  numSerieDoc              String?                    @db.VarChar(40)
  numCorreDoc              String?                    @db.VarChar(40)
  numeroDocumento          String?
  fechaDocumento           DateTime @default(now())
  esConCotizacion       Boolean     @default(false)             // false=Compra Directa, true=Con Cotizaci贸n
  tipoProductoId        BigInt                                  // Hidrobiol贸gico, Agroindustria, Insumos, etc.
  tipoEstadoProductoId  BigInt                                  // Fresco, Congelado, Conserva, etc.
  destinoProductoId     BigInt                                  // Mercado Local, Exterior
  proveedorId           BigInt?                                 // Proveedor 煤nico (Compra Directa) o NULL (M煤ltiples proveedores)
  formaPagoId           BigInt?                                 // Contado, Cr茅dito 30 d铆as, etc.
  modoDespachoRecepcionId BigInt?                               // Entrega en almac茅n, puerto, etc.
  monedaId              BigInt?                                 // PEN, USD, EUR
  tipoCambio            Decimal?                                // Tipo de cambio del d铆a
  ordenTrabajoId        BigInt?                                 // Si est谩 vinculado a una OT espec铆fica
  fechaRequerida        DateTime?                               // Fecha en que se necesita el producto
  fechaAprobacion       DateTime?                               // Cu谩ndo fue aprobado
  solicitanteId         BigInt?                                 // Usuario que solicita la compra
  respComprasId         BigInt?                                 // Responsable del 谩rea de compras
  respProduccionId      BigInt?                                 // Responsable de producci贸n (si aplica)
  respAlmacenId         BigInt?                                 // Responsable del almac茅n receptor
  supervisorCampoId     BigInt?                                 // Supervisor en campo/puerto
  aprobadoPorId         BigInt?                                 // Usuario que aprob贸 el requerimiento
  autorizaCompraId      BigInt?                                 // Usuario que autoriza la compra
  estadoId              BigInt                                  // Estado desde EstadosMultifuncion
  centroCostoId         BigInt?                                 // Centro de costo que asume el gasto
  urlReqCompraPdf       String?                                 // URL del PDF generado
  creadoEn              DateTime    @default(now())             // Fecha de creaci贸n del registro
  actualizadoEn         DateTime    @updatedAt                  // ltima actualizaci贸n
  creadoPor             BigInt?                                 // Usuario que cre贸 el registro
  actualizadoPor        BigInt?                                 // Usuario que actualiz贸 por 煤ltima vez
  porcentajeIGV         Decimal?                                // Porcentaje de IGV
  esExoneradoAlIGV      Boolean?   @default(false)             // Es exonerado al IGV
  
  tipoProducto          TipoProducto @relation(fields: [tipoProductoId], references: [id])
  tipoEstadoProducto    TipoEstadoProducto @relation(fields: [tipoEstadoProductoId], references: [id])
  destinoProducto       DestinoProducto @relation(fields: [destinoProductoId], references: [id])
  proveedor             EntidadComercial? @relation("ProveedorRequerimiento", fields: [proveedorId], references: [id])
  formaPago             FormaPago? @relation(fields: [formaPagoId], references: [id])
  modoDespachoRecepcion ModoDespachoRecepcion? @relation(fields: [modoDespachoRecepcionId], references: [id])
  tipoDocumento         TipoDocumento @relation(fields: [tipoDocumentoId], references: [id])
  serieDoc              SerieDoc? @relation(fields: [serieDocId], references: [id])
  empresa               Empresa @relation(fields: [empresaId], references: [id])
  moneda                Moneda? @relation(fields: [monedaId], references: [id])
  estado                EstadoMultiFuncion @relation(fields: [estadoId], references: [id])
  
  cotizacionesProveedores CotizacionProveedor[]                 // Cotizaciones recibidas (si aplica)
  detalles              DetalleReqCompra[]                      // Items del requerimiento
  ordenesCompra         OrdenCompra[]                           // rdenes de compra generadas
  entregaARendir        EntregaARendirPCompras?                 // Entrega a rendir asociada (relaci贸n 1:1)
  
  @@index([empresaId, fechaDocumento])
  @@index([estadoId])
  @@index([proveedorId])
}


model DetalleReqCompra {
  id                       BigInt      @id @default(autoincrement())
  requerimientoCompraId    BigInt                                // Requerimiento al que pertenece
  productoId               BigInt                                // Producto solicitado
  proveedorId              BigInt?                               // Proveedor espec铆fico del item (CAMPO CLAVE para generar OC)
  cantidad         Decimal                              // Cantidad que se debe comprar (solicitada - almacen)
  costoUnitario            Decimal?                             // Precio unitario negociado/cotizado
  subtotal                 Decimal?                             // cantidadAComprar * costoUnitario
  monedaId                 BigInt?                              // Moneda del precio (puede diferir de la cabecera)
  cotizacionProveedorId    BigInt?                              // Si viene de una cotizaci贸n seleccionada
  centroCostoId            BigInt?                              // Centro de costo espec铆fico del item
  observaciones            String?     @db.Text                 // Notas espec铆ficas del item
  ordenCompraDetalleId     BigInt?                              // ID del detalle de OC generado
  creadoEn                 DateTime    @default(now())
  actualizadoEn            DateTime    @updatedAt
  aprobadoParaOrdenCompra  Boolean     @default(false)          // Si se aprob贸 para generar una OC
  
  requerimientoCompra      RequerimientoCompra @relation(fields: [requerimientoCompraId], references: [id], onDelete: Cascade)
  producto                 Producto @relation(fields: [productoId], references: [id])
  proveedor                EntidadComercial? @relation("ProveedorDetalleReq", fields: [proveedorId], references: [id])
  detallesCotizacion       DetalleCotizacionProveedor[]         // Detalles de cotizaciones que referencian este item
  detalleMovimientos       DetalleMovimientoAlmacen[]           // Movimientos de almac茅n que atendieron este item
  
  @@index([requerimientoCompraId])
  @@index([productoId])
  @@index([proveedorId])
}

// ============================================================================
// COTIZACIN DE PROVEEDOR - CABECERA
// Un requerimiento puede tener N cotizaciones (una por cada proveedor consultado)
// Un proveedor puede cotizar varias veces (actualizar precios, nuevas ofertas, etc.)
// Cada cotizaci贸n se crea autom谩ticamente con todos los items del requerimiento
// El usuario puede modificar precios, cantidades y AGREGAR productos alternativos
// ============================================================================
model CotizacionProveedor {
  id                    BigInt      @id @default(autoincrement())
  requerimientoCompraId BigInt                                  // Requerimiento al que pertenece
  proveedorId           BigInt                                  // Proveedor que presenta la cotizaci贸n
  monedaId              BigInt                                  // Moneda de la cotizaci贸n
  urlCotizacionPdf      String?                                 // PDF de la cotizaci贸n del proveedor
  fechaCotizacion       DateTime    @default(now())             // Fecha de la cotizaci贸n
  creadoEn              DateTime    @default(now())
  creadoPor             BigInt?
  actualizadoEn         DateTime    @updatedAt
  
  requerimientoCompra   RequerimientoCompra @relation(fields: [requerimientoCompraId], references: [id], onDelete: Cascade)
  proveedor             EntidadComercial @relation("CotizacionProveedor", fields: [proveedorId], references: [id])
  moneda                Moneda @relation(fields: [monedaId], references: [id])
  detalles              DetalleCotizacionProveedor[]
  
  @@index([requerimientoCompraId])
  @@index([proveedorId])
}

// ============================================================================
// DETALLE DE COTIZACIN DE PROVEEDOR
// Se crea autom谩ticamente copiando los items del requerimiento
// El usuario puede:
//   1. Modificar precioUnitario y cantidad de items existentes
//   2. AGREGAR nuevos productos (alternativos o adicionales que ofrece el proveedor)
// ============================================================================
model DetalleCotizacionProveedor {
  id                    BigInt      @id @default(autoincrement())
  cotizacionProveedorId BigInt                                  // Cotizaci贸n a la que pertenece
  detalleReqCompraId    BigInt?                                 // Detalle del requerimiento original (NULL si es producto alternativo)
  productoId            BigInt                                  // Producto cotizado
  cantidad              Decimal                                 // Cantidad ofrecida
  precioUnitario        Decimal     @default(0) @db.Decimal(18, 6)  // Precio por unidad
  subtotal              Decimal     @default(0) @db.Decimal(18, 2)  // cantidad * precioUnitario
  esProductoAlternativo Boolean     @default(false)             // TRUE si es un producto nuevo que ofrece el proveedor
  observaciones         String?                                 // Observaciones del item (ej: "Producto alternativo de mejor calidad")
  creadoEn              DateTime    @default(now())
  actualizadoEn         DateTime    @updatedAt
  esSeleccionadoParaOrdenCompra Boolean @default(false)
  
  cotizacionProveedor   CotizacionProveedor @relation(fields: [cotizacionProveedorId], references: [id], onDelete: Cascade)
  detalleReqCompra      DetalleReqCompra? @relation(fields: [detalleReqCompraId], references: [id])
  producto              Producto @relation(fields: [productoId], references: [id])
  
  @@index([cotizacionProveedorId])
  @@index([detalleReqCompraId])
  @@index([productoId])
}


model DocumentacionEmbarcacion {
  id               BigInt         @id @default(autoincrement())
  embarcacionId    BigInt
  documentoPescaId BigInt
  numeroDocumento  String?
  fechaEmision     DateTime?
  fechaVencimiento DateTime?
  urlDocPdf String?
  docVencido Boolean @default(false)
  observaciones    String?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime
  cesado Boolean @default(false)

  embarcacion     Embarcacion   @relation(fields: [embarcacionId], references: [id])
}

model DocumentacionPersonal {
  id               BigInt         @id @default(autoincrement())
  personalId       BigInt
  documentoPescaId BigInt
  numeroDocumento  String?
  fechaEmision     DateTime?
  fechaVencimiento DateTime?
  urlDocPdf String?
  docVencido Boolean @default(false)
  observaciones    String?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime
  cesado Boolean @default(false)

  personal        Personal        @relation(fields: [personalId], references: [id])
}

model DocumentoPesca {
  id                       BigInt                     @id @default(autoincrement())
  nombre                   String
  descripcion              String?
  obligatorio              Boolean
  createdAt                DateTime                   @default(now())
  updatedAt                DateTime
  cesado                   Boolean                    @default(false)
  paraEmbarcacion          Boolean                    @default(false)
  paraOperacionFaena       Boolean                    @default(false)
  paraTripulantes          Boolean                    @default(false)

}

model Embarcacion {
  id                                     BigInt                     @id @default(autoincrement())
  matricula                              String                     @unique
  capacidadBodegaTon                     Decimal?
  esloraM                                Decimal?
  mangaM                                 Decimal?
  puntalM                                Decimal?
  motorMarca                             String?
  motorPotenciaHp                        Int?
  anioFabricacion                        Int?
  proveedorGpsId                         BigInt?
  tabletMarca                            String?
  tabletModelo                           String?
  fechaCreacion                          DateTime                   @default(now())
  fechaActualizacion                     DateTime
  activoId                               BigInt                     @unique
  tipoEmbarcacionId                      BigInt
  estadoActivoId                         BigInt
  urlFotoEmbarcacion                     String?

  tipoEmbarcacion   TipoEmbarcacion @relation(fields: [tipoEmbarcacionId], references: [id])
  documentaciones DocumentacionEmbarcacion[]
  faenas FaenaPesca[] @relation("EmbarcacionFaenas")
  faenasConsumo FaenaPescaConsumo[] @relation("EmbarcacionFaenasConsumo")
  activo            Activo          @relation(fields: [activoId], references: [id])
}

model Empresa {
  id                   BigInt               @id @default(autoincrement())
  razonSocial          String
  nombreComercial      String?
  ruc                  String
  direccion            String?
  telefono             String?
  email                String?
  fechaCreacion        DateTime             @default(now())
  fechaActualizacion   DateTime
  logo                 String?
  porcentajeIgv        Decimal?
  cesado               Boolean              @default(false)
  representantelegalId BigInt?
  cuentaDetraccion     String?
  montoMinimoRetencion Decimal?
  porcentajeRetencion  Decimal?
  soyAgentePercepcion  Boolean              @default(false)
  soyAgenteRetencion   Boolean              @default(false)
  entidadComercialId   BigInt?

    //  AGREGAR: M谩rgenes de utilidad globales (heredados a productos)
  margenMinimoPermitido Decimal?            @default(20.00) @db.Decimal(5, 2)  // % m铆nimo de margen (ej: 20.00%)
  margenUtilidadObjetivo Decimal?           @default(50.00) @db.Decimal(5, 2)  // % objetivo de margen (ej: 50.00%)

  sedes SedesEmpresa[]
  centrosCosto EmpresaCentroCosto[]
  movimientosAlmacen MovimientoAlmacen[]
  ordenesCompra OrdenCompra[]
  requerimientosCompra RequerimientoCompra[]
  usuarios Usuario[]
  cotizacionVentas CotizacionVentas[]
  preFactura PreFactura[]

  movimientosCajaOrigen   MovimientoCaja[] @relation("EmpresaOrigenMovCaja")
  movimientosCajaDestino  MovimientoCaja[] @relation("EmpresaDestinoMovCaja")
  ordenesMantenimiento OTMantenimiento[]
  contratosServicio       ContratoServicio[]    @relation("ContratoServicioEmpresa")

}

model EmpresaCentroCosto {
  EmpresaID          BigInt
  CentroCostoID      BigInt
  ResponsableID      BigInt
  ProveedorExternoID BigInt?
  Activo             Boolean     @default(true)
  id                 BigInt      @id @default(autoincrement())

  empresa      Empresa     @relation(fields: [EmpresaID], references: [id])
  centroCosto  CentroCosto @relation(fields: [CentroCostoID], references: [id])
}

model EntidadComercial {
  id                   BigInt                @id @default(autoincrement())
  empresaId            BigInt
  tipoDocumentoId      BigInt
  tipoEntidadId        BigInt
  formaPagoId          BigInt
  vendedorId           BigInt?
  agenciaEnvioId       BigInt?
  agrupacionEntidadId  BigInt?
  numeroDocumento      String                @db.VarChar(20)
  razonSocial          String                @db.VarChar(255)
  nombreComercial      String?               @db.VarChar(255)
  esCliente            Boolean               @default(false)
  esProveedor          Boolean               @default(false)
  esCorporativo        Boolean               @default(false)
  estado               Boolean               @default(true)
  observaciones        String?
  codigoErpFinanciero  String?               @db.VarChar(50)
  custodiaStock        Boolean               @default(false)
  controlLote          Boolean               @default(false)
  controlFechaVenc     Boolean               @default(false)
  controlFechaProd     Boolean               @default(false)
  controlFechaIngreso  Boolean               @default(false)
  controlSerie         Boolean               @default(false)
  controlEnvase        Boolean               @default(false)
  sujetoRetencion      Boolean               @default(false)
  sujetoPercepcion     Boolean               @default(false)
  creadoEn             DateTime              @default(now())
  actualizadoEn        DateTime
  creadoPor            BigInt?
  actualizadoPor       BigInt?
  condicionHabidoSUNAT Boolean               @default(true)
  estadoActivoSUNAT    Boolean               @default(true)
  esAgenteRetencion    Boolean               @default(false)

  tipoDocumento        TiposDocIdentidad   @relation(fields: [tipoDocumentoId], references: [id])
  tipoEntidad          TipoEntidad         @relation(fields: [tipoEntidadId], references: [id])
  formaPago            FormaPago           @relation(fields: [formaPagoId], references: [id])
  agrupacionEntidad    AgrupacionEntidad?  @relation(fields: [agrupacionEntidadId], references: [id])
  contactos            ContactoEntidad[]
  direcciones          DireccionEntidad[]
  precios              PrecioEntidad[]
  vehiculos            VehiculoEntidad[]
  lineasCredito        LineaCreditoEntidad[]
  ctaCteEntidad        CtaCteEntidad[]

  movimientosAlmacen MovimientoAlmacen[]
  kardexAlmacenes   KardexAlmacen[]
  requerimientosCompra RequerimientoCompra[] @relation("ProveedorRequerimiento")
  detallesReqCompra DetalleReqCompra[] @relation("ProveedorDetalleReq")
  cotizacionesProveedores CotizacionProveedor[] @relation("CotizacionProveedor")
  ordenesCompra OrdenCompra[] @relation("ProveedorOrdenCompra")
  movimientosCaja MovimientoCaja[]
  detalleMovsEntregaRendir DetMovsEntregaRendir[]
  detalleMovsEntregaRendirPescaConsumo DetMovsEntRendirPescaConsumo[]
  detalleMovsEntregaRendirPCompras DetMovsEntregaRendirPCompras[]
  saldosDetProductoCliente SaldosDetProductoCliente[]
  saldosProductoCliente SaldosProductoCliente[]

  detalleMovsEntregaRendirPVentas DetMovsEntregaRendirPVentas[] @relation("ProveedorMovPVentas")
  cotizacionesVentas CotizacionVentas[]
  preFacturas PreFactura[] @relation("ClientePreFactura")
  costosExportacionCotizacion CostosExportacionCotizacion[] @relation("ProveedorCostoExport")
  costosExportacionPorIncoterm CostoExportacionPorIncoterm[] @relation("ProveedorDefaultCostoIncoterm")
  detMovsEntregaRendirMovAlmacen DetMovsEntregaRendirMovAlmacen[]
  tareasContratista         DetTareasOT[]       @relation("ContratistaTareaOT")
  insumosProveedorSugerido  DetInsumosTareaOT[] @relation("ProveedorSugeridoInsumoOT")
  contratosServicioCliente  ContratoServicio[]  @relation("ContratoServicioCliente")
  movimientosContratoServicio    DetMovsEntregaRendirContratoServicios[] @relation("ProveedorMovContratoServicio")
}

model LineaCreditoEntidad {
  id                 BigInt           @id @default(autoincrement())
  entidadComercialId BigInt
  montoMaximo        Decimal
  monedaId           BigInt
  diasCredito        Int
  vigenteDesde       DateTime
  vigenteHasta       DateTime?
  condiciones        String?
  observaciones      String?
  activo             Boolean          @default(true)
fechaCreacion        DateTime               @default(now())
fechaActualizacion   DateTime?
creadoPor            BigInt?
actualizadoPor       BigInt?

  entidadComercial   EntidadComercial @relation(fields: [entidadComercialId], references: [id])
  moneda Moneda @relation(fields: [monedaId], references: [id])
}

model VehiculoEntidad {
  id                 BigInt           @id @default(autoincrement())
  entidadComercialId BigInt
  placa              String           @db.VarChar(20)
  marca              String?
  modelo             String?
  color              String?
  anio               Int?
  tipoVehiculoId     BigInt
  capacidadTon       Decimal?
  numeroSerie        String?
  numeroMotor        String?
  cesado             Boolean          @default(false)
  fechaCreacion        DateTime               @default(now())
  fechaActualizacion   DateTime?
  creadoPor            BigInt?
  actualizadoPor       BigInt?
  activoId           BigInt?
  observaciones      String?

  entidadComercial   EntidadComercial @relation(fields: [entidadComercialId], references: [id])
  tipoVehiculo       TipoVehiculo     @relation(fields: [tipoVehiculoId], references: [id])
}

model PrecioEntidad {
  id                 BigInt           @id @default(autoincrement())
  entidadComercialId BigInt
  productoId         BigInt
  monedaId           BigInt
  precioUnitario     Decimal
  vigenteDesde       DateTime
  vigenteHasta       DateTime?
  observaciones      String?
  activo             Boolean          @default(true)
fechaCreacion        DateTime               @default(now())
fechaActualizacion   DateTime?
creadoPor            BigInt?
actualizadoPor       BigInt?

  entidadComercial   EntidadComercial @relation(fields: [entidadComercialId], references: [id])
  moneda             Moneda           @relation(fields: [monedaId], references: [id])
  producto           Producto         @relation(fields: [productoId], references: [id])

    //  AGREGAR: Relaci贸n inversa con DetCotizacionVentas
  detallesCotizacionVentas DetCotizacionVentas[]

  @@index([entidadComercialId])
  @@index([productoId])
  @@index([entidadComercialId, productoId, activo])  // Para buscar precio activo de cliente-producto
  @@index([vigenteDesde, vigenteHasta])              // Para b煤squedas por rango de fechas

}

model DireccionEntidad {
  id                 BigInt           @id @default(autoincrement())
  entidadComercialId BigInt
  direccion          String
  direccionArmada    String?
  ubigeoId           BigInt
  fiscal             Boolean          @default(false)
  almacenPrincipal   Boolean          @default(false)
  referencia         String?
  telefono           String?
  correo             String?
  activo             Boolean          @default(true)
  fechaCreacion        DateTime               @default(now())
  fechaActualizacion   DateTime?
  creadoPor            BigInt?
  actualizadoPor       BigInt?

  entidadComercial   EntidadComercial @relation(fields: [entidadComercialId], references: [id])
  ubigeo             Ubigeo           @relation(fields: [ubigeoId], references: [id])
}

model ContactoEntidad {
  id                 BigInt           @id @default(autoincrement())
  entidadComercialId BigInt
  nombres            String
  cargoId            BigInt?
  telefono           String?
  correoCorportivo   String?
  correoPersonal     String?
  compras            Boolean          @default(false)
  ventas             Boolean          @default(false)
  finanzas           Boolean          @default(false)
  logistica          Boolean          @default(false)
  representanteLegal Boolean          @default(false)
  observaciones      String?
  activo             Boolean          @default(true)
  fechaCreacion        DateTime               @default(now())
  fechaActualizacion   DateTime?
  creadoPor            BigInt?
  actualizadoPor       BigInt?

   entidadComercial   EntidadComercial @relation(fields: [entidadComercialId], references: [id])
  contratosServicio       ContratoServicio[]    @relation("ContratoServicioContacto")

}

model CtaCteEntidad {
  id                   BigInt                 @id @default(autoincrement())
  entidadComercialId   BigInt
  fechaCreacion        DateTime               @default(now())
  fechaActualizacion   DateTime?
  creadoPor            BigInt?
  actualizadoPor       BigInt?
  bancoId BigInt
  monedaId BigInt
  numeroCuenta String?
  numeroCuentaCCI String?
  numeroTelefonoBilletera String?
  BilleteraDigital Boolean @default(false)
  activo Boolean @default(true)

  entidadComercial     EntidadComercial @relation(fields: [entidadComercialId], references: [id])
  banco Banco @relation(fields: [bancoId], references: [id])
  moneda Moneda @relation(fields: [monedaId], references: [id])

  movimientosCaja      MovimientoCaja[]
}

model EntregaARendir {
  id                   BigInt                 @id @default(autoincrement())
  temporadaPescaId     BigInt
  entregaLiquidada     Boolean                @default(false)
  fechaLiquidacion     DateTime?
  fechaCreacion        DateTime               @default(now())
  fechaActualizacion   DateTime
  respEntregaRendirId  BigInt
  centroCostoId        BigInt
  urlLiquidacionPdf String?
  respLiquidacionId BigInt?
  
  temporadaPesca        TemporadaPesca @relation(fields: [temporadaPescaId], references: [id])
  respLiquidacion Personal? @relation("LiquidadorIndustrial", fields: [respLiquidacionId], references: [id])
  respEntregaRendir Personal @relation("ResponsableEntregaIndustrial", fields: [respEntregaRendirId], references: [id])
  centroCosto CentroCosto @relation(fields: [centroCostoId], references: [id])
  movimientos           DetMovsEntregaRendir[]

  @@index([respEntregaRendirId])
  @@index([entregaLiquidada])
  @@index([temporadaPescaId])
}

model EntregaARendirPCompras {
  id                           BigInt      @id @default(autoincrement())
  requerimientoCompraId        BigInt      @unique                     // Requerimiento que origina las entregas (relaci贸n 1:1)
  respEntregaRendirId          BigInt                                  // Personal responsable de rendir cuentas
  entregaLiquidada             Boolean     @default(false)             // Si ya se cerr贸 y liquid贸 todo
  fechaLiquidacion             DateTime?                               // Cu谩ndo se liquid贸
  centroCostoId                BigInt                                  // Centro de costo que asume los gastos
  fechaCreacion                DateTime    @default(now())
  fechaActualizacion           DateTime    @updatedAt
  creadoPor                    BigInt?
  actualizadoPor               BigInt?
  urlLiquidacionPdf String?
  respLiquidacionId BigInt?
  
  requerimientoCompra          RequerimientoCompra @relation(fields: [requerimientoCompraId], references: [id])
  movimientos                  DetMovsEntregaRendirPCompras[]          // TODOS los movimientos (entregas + gastos + devoluciones)
  respLiquidacion Personal? @relation("LiquidadorCompras", fields: [respLiquidacionId], references: [id])
  respEntregaRendir Personal @relation("ResponsableEntregaCompras", fields: [respEntregaRendirId], references: [id])
  centroCosto CentroCosto @relation(fields: [centroCostoId], references: [id])

  @@index([respEntregaRendirId])
  @@index([entregaLiquidada])
  @@index([requerimientoCompraId])
}

model EntregaARendirMovAlmacen {
  id                           BigInt      @id @default(autoincrement())
  movimientoAlmacenId        BigInt      @unique                     // Movimiento de almacen que origina las entregas (relaci贸n 1:1)
  respEntregaRendirId          BigInt                                  // Personal responsable de rendir cuentas
  entregaLiquidada             Boolean     @default(false)             // Si ya se cerr贸 y liquid贸 todo
  fechaLiquidacion             DateTime?                               // Cu谩ndo se liquid贸
  centroCostoId                BigInt                                  // Centro de costo que asume los gastos
  fechaCreacion                DateTime    @default(now())
  fechaActualizacion           DateTime    @updatedAt
  creadoPor                    BigInt?
  actualizadoPor               BigInt?
  urlLiquidacionPdf String?
  respLiquidacionId BigInt?

  movimientoAlmacen MovimientoAlmacen @relation(fields: [movimientoAlmacenId], references: [id])
  detMovEntregaRendirMovAlmacen DetMovsEntregaRendirMovAlmacen[]
  respLiquidacion Personal? @relation("LiquidadorInventario", fields: [respLiquidacionId], references: [id])
  respEntregaRendir Personal @relation("ResponsableEntregaInventario", fields: [respEntregaRendirId], references: [id])
  centroCosto CentroCosto @relation(fields: [centroCostoId], references: [id])

  @@index([respEntregaRendirId])
  @@index([entregaLiquidada])
  @@index([movimientoAlmacenId])
}

model DetMovsEntregaRendirMovAlmacen {
  id                       BigInt      @id @default(autoincrement())
  entregaARendirMovAlmacenId BigInt                                      // Entrega a rendir a la que pertenece
  tipoMovimientoId         BigInt                                      // 1=Entrega Inicial, 2=Gasto, 3=Devoluci贸n, 4=Ampliaci贸n
  productoId               BigInt?                                     // Producto que se movi贸
  responsableId            BigInt                                      // Personal que realiz贸 el movimiento
  fechaMovimiento          DateTime                                    // Fecha del movimiento
  monto                    Decimal                                     // Monto del movimiento (positivo o negativo seg煤n tipo)
  monedaId                 BigInt?                                     // Moneda del movimiento (PEN, USD)
  descripcion              String?     @db.Text                        // Descripci贸n detallada del movimiento
  entidadComercialId       BigInt?                                     // Proveedor o tercero al que se le pag贸
  
  tipoDocumentoId        BigInt?                                     // Factura, Boleta, Recibo, Ticket, Sin Comprobante
  numeroSerieComprobante        String?                              // N煤mero Serie del comprobante
  numeroCorrelativoComprobante String?                               // N煤mero Correlativo del comprobante

  urlComprobanteMovimiento String?                                     // URL del comprobante escaneado/fotografiado
  validadoTesoreria        Boolean     @default(false)                 // Si tesorer铆a valid贸 el movimiento
  fechaValidacionTesoreria DateTime?                                   // Cu谩ndo se valid贸
  operacionSinFactura      Boolean     @default(false)                 // Si no hay comprobante formal
  motivoSinFactura         String?     @db.Text                        // Por qu茅 no hay comprobante (compra informal, etc.)
  operacionMovCajaId       BigInt?                                     // Si se registr贸 en movimiento de caja
  fechaOperacionMovCaja    DateTime?                                   // Fecha del movimiento de caja
  urlComprobanteOperacionMovCaja String?                               // Comprobante del movimiento de caja
  moduloOrigenMovCajaId    BigInt?                                     // M贸dulo que origin贸 el movimiento (Compras, Ventas, etc.)
  centroCostoId            BigInt                                      // Centro de costo del movimiento
  creadoEn                 DateTime    @default(now())
  actualizadoEn            DateTime    @updatedAt
  
  entregaARendirMovAlmacen   EntregaARendirMovAlmacen @relation(fields: [entregaARendirMovAlmacenId], references: [id], onDelete: Cascade)
  tipoMovimiento           TipoMovEntregaRendir @relation(fields: [tipoMovimientoId], references: [id])
  entidadComercial         EntidadComercial? @relation(fields: [entidadComercialId], references: [id])
  moneda Moneda? @relation(fields: [monedaId], references: [id])
  tipoDocumento TipoDocumento? @relation(fields: [tipoDocumentoId], references: [id])
  producto Producto? @relation(fields: [productoId], references: [id])
}


model EntregaARendirContratoServicios {
  id                           BigInt      @id @default(autoincrement())
  contratoServicioId           BigInt      @unique                     // Contrato Servicios que origina las entregas (relaci贸n 1:1)
  respEntregaRendirId          BigInt                                  // Personal responsable de rendir cuentas
  entregaLiquidada             Boolean     @default(false)             // Si ya se cerr贸 y liquid贸 todo
  fechaLiquidacion             DateTime?                               // Cu谩ndo se liquid贸
  centroCostoId                BigInt                                  // Centro de costo que asume los gastos
  fechaCreacion                DateTime    @default(now())
  fechaActualizacion           DateTime    @updatedAt
  creadoPor                    BigInt?
  actualizadoPor               BigInt?
  urlLiquidacionPdf            String?     @db.VarChar(500)
  respLiquidacionId            BigInt?

  contratoServicio             ContratoServicio @relation("EntregaRendirContrato", fields: [contratoServicioId], references: [id])
  detallesMovimientos          DetMovsEntregaRendirContratoServicios[]
  respLiquidacion              Personal? @relation("LiquidadorContratoServicio", fields: [respLiquidacionId], references: [id])
  respEntregaRendir            Personal @relation("ResponsableEntregaContratoServicio", fields: [respEntregaRendirId], references: [id])
  centroCosto                  CentroCosto @relation("EntregaRendirContratoServicio", fields: [centroCostoId], references: [id])

  @@index([respEntregaRendirId])
  @@index([entregaLiquidada])
  @@index([contratoServicioId])
}

model DetMovsEntregaRendirContratoServicios {
  id                                   BigInt      @id @default(autoincrement())
  entregaARendirContratoServicioId     BigInt                                      // Entrega a rendir a la que pertenece
  tipoMovimientoId                     BigInt                                      // 1=Entrega Inicial, 2=Gasto, 3=Devoluci贸n, 4=Ampliaci贸n
  productoId                           BigInt?                                     // Producto que se movi贸
  responsableId                        BigInt                                      // Personal que realiz贸 el movimiento
  fechaMovimiento                      DateTime                                    // Fecha del movimiento
  monto                                Decimal     @db.Decimal(18, 4)              // Monto del movimiento (positivo o negativo seg煤n tipo)
  monedaId                             BigInt?                                     // Moneda del movimiento (PEN, USD)
  descripcion                          String?     @db.Text                        // Descripci贸n detallada del movimiento
  entidadComercialId                   BigInt?                                     // Proveedor o tercero al que se le pag贸
  
  tipoDocumentoId                      BigInt?                                     // Factura, Boleta, Recibo, Ticket, Sin Comprobante
  numeroSerieComprobante               String?     @db.VarChar(20)                 // N煤mero Serie del comprobante
  numeroCorrelativoComprobante         String?     @db.VarChar(20)                 // N煤mero Correlativo del comprobante

  urlComprobanteMovimiento             String?     @db.VarChar(500)                // URL del comprobante escaneado/fotografiado
  validadoTesoreria                    Boolean     @default(false)                 // Si tesorer铆a valid贸 el movimiento
  fechaValidacionTesoreria             DateTime?                                   // Cu谩ndo se valid贸
  operacionSinFactura                  Boolean     @default(false)                 // Si no hay comprobante formal
  motivoSinFactura                     String?     @db.Text                        // Por qu茅 no hay comprobante (compra informal, etc.)
  operacionMovCajaId                   BigInt?                                     // Si se registr贸 en movimiento de caja
  fechaOperacionMovCaja                DateTime?                                   // Fecha del movimiento de caja
  urlComprobanteOperacionMovCaja       String?     @db.VarChar(500)                // Comprobante del movimiento de caja
  moduloOrigenMovCajaId                BigInt?                                     // M贸dulo que origin贸 el movimiento (Compras, Ventas, etc.)
  centroCostoId                        BigInt                                      // Centro de costo del movimiento
  creadoEn                             DateTime    @default(now())
  actualizadoEn                        DateTime    @updatedAt
  
  entregaARendirContratoServicio       EntregaARendirContratoServicios @relation(fields: [entregaARendirContratoServicioId], references: [id], onDelete: Cascade)
  tipoMovimiento                       TipoMovEntregaRendir @relation(fields: [tipoMovimientoId], references: [id])
  responsable                          Personal @relation("ResponsableMovContratoServicio", fields: [responsableId], references: [id])
  entidadComercial                     EntidadComercial? @relation("ProveedorMovContratoServicio", fields: [entidadComercialId], references: [id])
  moneda                               Moneda? @relation(fields: [monedaId], references: [id])
  tipoDocumento                        TipoDocumento? @relation(fields: [tipoDocumentoId], references: [id])
  producto                             Producto? @relation(fields: [productoId], references: [id])
  centroCosto                          CentroCosto @relation("DetMovContratoServicio", fields: [centroCostoId], references: [id])
  
  @@index([entregaARendirContratoServicioId])
  @@index([tipoMovimientoId])
  @@index([responsableId])
  @@index([fechaMovimiento])
}

model EntregaARendirPescaConsumo {
  id                           BigInt                         @id @default(autoincrement())
  novedadPescaConsumoId        BigInt
  entregaLiquidada             Boolean                        @default(false)
  fechaLiquidacion             DateTime?
  fechaCreacion                DateTime                       @default(now())
  fechaActualizacion           DateTime
  respEntregaRendirId          BigInt
  centroCostoId                BigInt
  urlLiquidacionPdf String?
  respLiquidacionId BigInt?

  novedadPescaConsumo   NovedadPescaConsumo @relation(fields: [novedadPescaConsumoId], references: [id])
  movimientos           DetMovsEntRendirPescaConsumo[]

  respLiquidacion Personal? @relation("LiquidadorConsumo", fields: [respLiquidacionId], references: [id])
  respEntregaRendir Personal @relation("ResponsableEntregaConsumo", fields: [respEntregaRendirId], references: [id])
  centroCosto CentroCosto @relation(fields: [centroCostoId], references: [id])

  @@index([respEntregaRendirId])
  @@index([entregaLiquidada])
  @@index([novedadPescaConsumoId])
}

model EstadoMultiFuncion {
  id               BigInt          @id @default(autoincrement())
  descripcion      String?
  cesado           Boolean         @default(false)
  createdAt        DateTime        @default(now())
  updatedAt        DateTime
  tipoProvieneDeId BigInt?
  severityColor String?

  tipoProvieneDe    TipoProvieneDe? @relation(fields: [tipoProvieneDeId], references: [id])
  cotizacionVentas CotizacionVentas[]
  ordenesCompra OrdenCompra[]
  movimientosAlmacen MovimientoAlmacen[]
  requerimientoCompra RequerimientoCompra[]
  movimientosCaja MovimientoCaja[]
  ordenesMantenimiento OTMantenimiento[]
  tareasOT                  DetTareasOT[]           @relation("EstadoTareaOT")
  insumosOT                 DetInsumosTareaOT[]     @relation("EstadoInsumoOT")
    contratosServicio       ContratoServicio[]    @relation("EstadoContratoServicio")

}

model FaenaPesca {
  id                      BigInt                    @id @default(autoincrement())
  temporadaId             BigInt
  descripcion             String?
  createdAt               DateTime                  @default(now())
  updatedAt               DateTime
  bolicheRedId            BigInt?
  embarcacionId           BigInt?
  fechaSalida             DateTime?
  fechaDescarga           DateTime?
  puertoDescargaId        BigInt?
  puertoSalidaId          BigInt?
  bahiaId                 BigInt?
  motoristaId             BigInt?
  patronId                BigInt?
  urlInformeFaena         String?
  urlReporteFaenaCalas    String?
  urlDeclaracionDesembarqueArmador String?
  estadoFaenaId           BigInt?
  toneladasCapturadasFaena     Decimal?
  fechaHoraFondeo     DateTime?
  puertoFondeoId      BigInt?

  temporada       TemporadaPesca @relation("FaenaTemporadas", fields: [temporadaId], references: [id])
  embarcacion     Embarcacion?   @relation("EmbarcacionFaenas", fields: [embarcacionId], references: [id])
  boliche         BolicheRed?    @relation("BolicheFaenas", fields: [bolicheRedId], references: [id])

  detallesDoc DetalleDocEmbarcacion[]
  tripulantes     TripulanteFaena[]
  detalleDocsTripulantes DetalleDocTripulantes[]
  calas Cala[]
  descargaFaena DescargaFaenaPesca?
  accionesPrevias DetAccionesPreviasFaena[]
}

model FaenaPescaConsumo {
  id                             BigInt                           @id @default(autoincrement())
  novedadPescaConsumoId          BigInt
  descripcion                    String?
  createdAt                      DateTime                         @default(now())
  updatedAt                      DateTime
  bolicheRedId                   BigInt?
  embarcacionId                  BigInt?
  fechaSalida                    DateTime?
  fechaDescarga                  DateTime?
  puertoDescargaId               BigInt?
  puertoSalidaId                 BigInt?
  bahiaId                        BigInt?
  motoristaId                    BigInt?
  patronId                       BigInt?
  urlInformeFaena                String?
  estadoFaenaId           BigInt?
  toneladasCapturadasFaena     Decimal?
  fechaHoraFondeo     DateTime?
  puertoFondeoId      BigInt?

  novedadPescaConsumo   NovedadPescaConsumo @relation(fields: [novedadPescaConsumoId], references: [id])
  embarcacion           Embarcacion?        @relation("EmbarcacionFaenasConsumo", fields: [embarcacionId], references: [id])
  boliche               BolicheRed?         @relation("BolicheFaenasConsumo", fields: [bolicheRedId], references: [id])

  // Relaciones de detalle
  detallesDocEmbarcacion    DetDocEmbarcacionPescaConsumo[]
  tripulantes               TripulanteFaenaConsumo[]
  detalleDocsTripulantes    DetDocTripulantesFaenaConsumo[]
  calas                     CalaFaenaConsumo[]
  descargaFaenaConsumo      DescargaFaenaConsumo?
  accionesPrevias           DetAccionesPreviasFaenaConsumo[]
}

model FamiliaProducto {
  id       BigInt     @id @default(autoincrement())
  nombre   String     @db.VarChar(120)
  productos             Producto[]
}

model FormaPago {
  id               BigInt             @id @default(autoincrement())
  nombre           String             @db.VarChar(50)
  descripcion      String?
  esCliente        Boolean            @default(false)
  esProveedor      Boolean            @default(false)
  activo           Boolean            @default(true)

  entidades   EntidadComercial[]
  ordenesCompra OrdenCompra[]
  requerimientosCompra RequerimientoCompra[]
  cotizacionesVentas CotizacionVentas[]
  preFacturas PreFactura[]

}


model KardexAlmacen {
  id                         BigInt            @id @default(autoincrement())
  empresaId                  BigInt            // Empresa (due帽a si esCustodia=false, custodia si esCustodia=true)
  almacenId                  BigInt            // Almac茅n f铆sico
  productoId                 BigInt            // Producto espec铆fico
  clienteId                  BigInt            // Cliente/Proveedor de la transacci贸n
  esCustodia                 Boolean           @default(false) // false=mercader铆a propia, true=mercader铆a en custodia
  fechaMovimientoAlmacen     DateTime          // Fecha del movimiento
  numDocCompleto             String            // N煤mero de Movimiento documento completo
  
  esIngresoEgreso            Boolean           @default(false) // false=EGRESO, true=INGRESO
  conceptoMovAlmacenId       BigInt            // Concepto del movimiento
  movimientoAlmacenId        BigInt            // ID del movimiento de almac茅n
  detalleMovimientoAlmacenId BigInt            // ID del detalle del movimiento
  
  // INGRESOS (0 si no aplica)
  ingresoCant                Decimal           @default(0) // Cantidad ingresada
  ingresoCantCostoUnit       Decimal           @default(0) // Costo unitario por cantidad
  ingresoCantCostoTotal      Decimal           @default(0) // Costo total por cantidad
  ingresoCantVariables       Decimal           @default(0) // Cantidad con variables de control
  ingresoPeso                Decimal           @default(0) // Peso ingresado
  ingresoPesoCostoUnit       Decimal           @default(0) // Costo unitario por peso
  ingresoPesoCostoTotal      Decimal           @default(0) // Costo total por peso
  ingresoPesoVariables       Decimal           @default(0) // Peso con variables de control
  
  // EGRESOS (0 si no aplica)
  egresoCant                 Decimal           @default(0) // Cantidad egresada
  egresoCantCostoUnit        Decimal           @default(0) // Costo unitario por cantidad
  egresoCantCostoTotal       Decimal           @default(0) // Costo total por cantidad
  egresoCantVariables        Decimal           @default(0) // Cantidad con variables de control
  egresoPeso                 Decimal           @default(0) // Peso egresado
  egresoPesoCostoUnit        Decimal           @default(0) // Costo unitario por peso
  egresoPesoCostoTotal       Decimal           @default(0) // Costo total por peso
  egresoPesoVariables        Decimal           @default(0) // Peso con variables de control
  
  // SALDOS INICIALES (antes del movimiento)
  saldoIniCant               Decimal           @default(0) // Saldo inicial cantidad (general)
  saldoInicialCostoUnitCant  Decimal           @default(0) // Costo unitario del saldo inicial
  saldoInicialCostoTotalCant Decimal           @default(0) // Costo total del saldo inicial
  saldoInicialCantVariables  Decimal           @default(0) // Saldo inicial con variables de control
  saldoInicialPeso           Decimal           @default(0) // Saldo inicial peso (general)
  saldoInicialPesoCostoUnit  Decimal           @default(0) // Costo unitario por peso del saldo inicial
  saldoInicialPesoCostoTotal Decimal           @default(0) // Costo total por peso del saldo inicial
  saldoInicialPesoVariables  Decimal           @default(0) // Saldo inicial peso con variables de control
  
  // SALDOS FINALES (despu茅s del movimiento)
  saldoFinalCant             Decimal           @default(0) // Saldo final cantidad (general)
  saldoFinalCostoUnitCant    Decimal           @default(0) // Costo unitario del saldo final
  saldoFinalCostoTotalCant   Decimal           @default(0) // Costo total del saldo final
  saldoFinalCantVariables    Decimal           @default(0) // Saldo final con variables de control
  saldoFinalPeso             Decimal           @default(0) // Saldo final peso (general)
  saldoFinalPesoCostoUnit    Decimal           @default(0) // Costo unitario por peso del saldo final
  saldoFinalPesoCostoTotal   Decimal           @default(0) // Costo total por peso del saldo final
  saldoFinalPesoVariables    Decimal           @default(0) // Saldo final peso con variables de control
  
  // VARIABLES DE CONTROL - Trazabilidad
  lote                       String            @default("") @db.VarChar(40)  // N煤mero de lote
  fechaVencimiento           DateTime?         // Fecha de vencimiento (null si no aplica)
  fechaProduccion            DateTime?         // Fecha de producci贸n (null si no aplica)
  fechaIngreso               DateTime?         // Fecha de ingreso al almac茅n (null si no aplica)
  numContenedor              String            @default("") @db.VarChar(40)  // N煤mero de contenedor
  nroSerie                   String            @default("") @db.VarChar(40)  // N煤mero de serie
  estadoId                   BigInt?           // Estado de la mercader铆a (null si no aplica)
  estadoCalidadId            BigInt?           // Estado de calidad (null si no aplica)

  // RELACIONES
  producto           Producto           @relation(fields: [productoId], references: [id])
  cliente            EntidadComercial?  @relation(fields: [clienteId], references: [id])
  conceptoMovAlmacen ConceptoMovAlmacen @relation(fields: [conceptoMovAlmacenId], references: [id])

  // NDICES OPTIMIZADOS - Ordenamiento: fecha DESC, INGRESOS primero (esIngresoEgreso DESC), id DESC
  @@index([empresaId, almacenId, productoId, esCustodia, fechaMovimientoAlmacen, esIngresoEgreso, id], name: "idx_kardex_propio_general")
  @@index([empresaId, almacenId, productoId, clienteId, esCustodia, fechaMovimientoAlmacen, esIngresoEgreso, id], name: "idx_kardex_custodia_general")
  @@index([empresaId, almacenId, productoId, esCustodia, lote, fechaIngreso, fechaProduccion, fechaVencimiento, estadoId, estadoCalidadId, numContenedor, nroSerie, fechaMovimientoAlmacen, esIngresoEgreso, id], name: "idx_kardex_propio_detallado")
  @@index([empresaId, almacenId, productoId, clienteId, esCustodia, lote, fechaIngreso, fechaProduccion, fechaVencimiento, estadoId, estadoCalidadId, numContenedor, nroSerie, fechaMovimientoAlmacen, esIngresoEgreso, id], name: "idx_kardex_custodia_detallado")
  @@index([empresaId, almacenId, fechaMovimientoAlmacen, productoId, esCustodia], name: "idx_kardex_reportes_fecha")
  @@index([productoId], name: "idx_kardex_producto")
  @@index([clienteId], name: "idx_kardex_cliente")
  @@index([movimientoAlmacenId], name: "idx_kardex_movimiento")
}


model Marca {
  id       BigInt     @id @default(autoincrement())
  nombre   String     @db.VarChar(120)
  productos  Producto[]
}

model ModuloSistema {
  id               BigInt             @id @default(autoincrement())
  nombre           String             @unique
  descripcion      String?
  activo           Boolean            @default(true)

  submodulos   SubmoduloSistema[]
}

model Moneda {
  id            BigInt          @id @default(autoincrement())
  codigoSunat   String          @unique
  nombreLargo   String?
  simbolo       String?
  activo        Boolean         @default(true)

  precios    PrecioEntidad[]
  ctacte     CuentaCorriente[]
  detEntregaRendirPescaIndustrial DetMovsEntregaRendir[]
  detEntregaRendirPescaConsumo DetMovsEntRendirPescaConsumo[]
  detEntregaRendirPCompras DetMovsEntregaRendirPCompras[]
  cotizacionesProveedores CotizacionProveedor[]
  ordenesCompra OrdenCompra[]
  requerimientosCompra RequerimientoCompra[]
  lineasCredito LineaCreditoEntidad[]
  ctaCteEntidad CtaCteEntidad[]

  cotizacionVentas CotizacionVentas[]
  costosExportacionCotizacion CostosExportacionCotizacion[]
  docRequeridaVentas DocRequeridaVentas[]
  preFactura PreFactura[]
  detMovsEntregaRendirPVentas DetMovsEntregaRendirPVentas[]
  costosExportacionPorIncoterm CostoExportacionPorIncoterm[] @relation("MonedaDefaultCostoIncoterm")
  detDocsReqCotizaVentas      DetDocsReqCotizaVentas[] @relation("MonedaDetDocsReqCotizaVentas")
  movimientosCaja  MovimientoCaja[]
  detMovsEntregaRendirMovAlmacen DetMovsEntregaRendirMovAlmacen[]
  ordenesMantenimiento OTMantenimiento[]
  contratosServicio       ContratoServicio[]    @relation("ContratoServicioMoneda")
  movimientosContratoServicio    DetMovsEntregaRendirContratoServicios[]
}

model MotivoAcceso {
  id                BigInt              @id @default(autoincrement())
  nombre            String              @unique
  descripcion       String?
  activo            Boolean             @default(true)

  accesos     AccesoInstalacion[]
}

model MotivoOriginoOT {
  id              BigInt            @id @default(autoincrement())
  nombre          String            @db.VarChar(40)
  descripcion     String?           @db.VarChar(200)
  activo          Boolean           @default(true)

  ordenesTrabajo OTMantenimiento[]
}

model MovimientoAlmacen {
  id                       BigInt                     @id @default(autoincrement())
  empresaId                BigInt
  tipoDocumentoId          BigInt
  conceptoMovAlmacenId     BigInt
  serieDocId               BigInt?
  numSerieDoc              String?                    @db.VarChar(40)
  numCorreDoc              String?                    @db.VarChar(40)
  numeroDocumento          String?
  fechaDocumento           DateTime
  entidadComercialId       BigInt?
  faenaPescaId             BigInt?
  embarcacionId            BigInt?
  ordenTrabajoId           BigInt?
  dirOrigenId              BigInt?
  dirDestinoId             BigInt?
  numGuiaSunat             String?                    @db.VarChar(40)
  fechaGuiaSunat           DateTime?
  transportistaId          BigInt?
  vehiculoId               BigInt?
  agenciaEnvioId           BigInt?
  dirAgenciaEnvioId        BigInt?
  personalRespAlmacen      BigInt?
  ordenCompraId            BigInt?
  pedidoVentaId            BigInt?
  estadoDocAlmacenId       BigInt
  esCustodia               Boolean                    @default(false)
  observaciones            String?
  creadoEn                 DateTime                   @default(now())
  actualizadoEn            DateTime
  creadoPor                BigInt?
  actualizadoPor           BigInt?
  urlMovAlmacenPdf         String?
  urlMovAlmacenConCostosPdf String?

  empresa Empresa @relation(fields: [empresaId], references: [id])
  tipoDocumento       TipoDocumento         @relation(fields: [tipoDocumentoId], references: [id])
  conceptoMovAlmacen  ConceptoMovAlmacen    @relation(fields: [conceptoMovAlmacenId], references: [id])
  serieDoc            SerieDoc?             @relation(fields: [serieDocId], references: [id])
  entidadComercial    EntidadComercial?     @relation(fields: [entidadComercialId], references: [id])
  estadoDocAlmacen    EstadoMultiFuncion    @relation(fields: [estadoDocAlmacenId], references: [id])
  detalles            DetalleMovimientoAlmacen[]
  preFacturas PreFactura[] @relation("MovimientoAlmacenToPreFactura")
  entregaARendirMovAlmacen EntregaARendirMovAlmacen?
  insumosOT  DetInsumosTareaOT[] @relation("MovAlmacenInsumoOT")

}

model MovimientoCaja {
  id                                      BigInt                        @id @default(autoincrement())
  empresaOrigenId                         BigInt
  empresaDestinoId                        BigInt?
  tipoMovimientoId                        BigInt
  entidadComercialId                      BigInt?
  monto                                   Decimal
  monedaId                                BigInt
  descripcion                             String?
  referenciaExtId                         String?
  tipoReferenciaId                        BigInt?
  usuarioId                               BigInt?
  estadoId                                BigInt
  cuentaCorrienteDestinoId                BigInt?
  cuentaCorrienteOrigenId                 BigInt
  fechaCreacion                           DateTime?                      @default(now())
  fechaActualizacion                      DateTime?                      @default(now())
  centroCostoId                           BigInt?
  moduloOrigenMotivoOperacionId           BigInt?
  origenMotivoOperacionId                 BigInt?
  fechaMotivoOperacion                    DateTime?
  usuarioMotivoOperacionId                BigInt?
  fechaOperacionMovCaja                   DateTime? @default(now())
  operacionSinFactura                     Boolean @default(false)
  urlComprobanteOperacionMovCaja          String?
  urlDocumentoMovCaja                     String?
  cuentaDestinoEntidadComercialId         BigInt?
  productoId                              BigInt?

  cuentaCorrienteOrigen     CuentaCorriente @relation("CuentaCorrienteOrigen", fields: [cuentaCorrienteOrigenId], references: [id])
  cuentaCorrienteDestino    CuentaCorriente? @relation("CuentaCorrienteDestino", fields: [cuentaCorrienteDestinoId], references: [id])
  tipoReferencia            TipoReferenciaMovimientoCaja? @relation(fields: [tipoReferenciaId], references: [id])
  asientosContables         AsientoContableInterfaz[]
  entidadComercial          EntidadComercial? @relation(fields: [entidadComercialId], references: [id])
  estadoMovimientoCaja      EstadoMultiFuncion @relation(fields: [estadoId], references: [id])
  empresaOrigen             Empresa @relation("EmpresaOrigenMovCaja", fields: [empresaOrigenId], references: [id])
  empresaDestino            Empresa? @relation("EmpresaDestinoMovCaja", fields: [empresaDestinoId], references: [id])
  moneda                    Moneda @relation(fields: [monedaId], references: [id])
  tipoMovimiento            TipoMovEntregaRendir @relation(fields: [tipoMovimientoId], references: [id])
  ctaCteEntidad             CtaCteEntidad? @relation(fields: [cuentaDestinoEntidadComercialId], references: [id])
  producto                  Producto? @relation(fields: [productoId], references: [id])

}

model NovedadPescaConsumo {
  id                         BigInt                       @id @default(autoincrement())
  empresaId                  BigInt
  BahiaId                    BigInt
  nombre                     String
  fechaInicio                DateTime
  fechaFin                   DateTime
  fechaCreacion              DateTime                     @default(now())
  fechaActualizacion         DateTime
  estadoNovedadPescaConsumoId         BigInt
  toneladasCapturadas     Decimal?
  novedadPescaConsumoIniciada   Boolean @default(false)
  urlResolucionPdf String?
  cuotaAlquiladaTon         Decimal?
  cuotaPropiaTon            Decimal?
  numeroResolucion          String?
  referenciaExtra           String?

  faenas                FaenaPescaConsumo[]
  entregasARendir       EntregaARendirPescaConsumo[]
}

model OrdenCompra {
  id                   BigInt      @id @default(autoincrement())
  empresaId            BigInt                                   // Empresa que emite la orden
  tipoDocumentoId       BigInt                                  // Tipo de documento (Se asigna el ID 17("ORDEN DE COMPRA"))
  serieDocId               BigInt?
  numSerieDoc              String?                    @db.VarChar(40)
  numCorreDoc              String?                    @db.VarChar(40)
  numeroDocumento          String?
  fechaDocumento           DateTime @default(now())
  requerimientoCompraId BigInt?                                 // Requerimiento que origin贸 esta orden
  proveedorId          BigInt                                   // Proveedor al que se le compra
  formaPagoId          BigInt?                                  // Forma de pago acordada
  monedaId             BigInt?                                  // Moneda de la orden
  tipoCambio           Decimal?                                 // Tipo de cambio aplicado
  fechaEntrega         DateTime?                                // Fecha comprometida de entrega
  fechaRecepcion       DateTime?                                // Fecha real de recepci贸n
  solicitanteId        BigInt?                                  // Usuario que solicit贸
  aprobadoPorId        BigInt?                                  // Usuario que aprob贸 la orden
  estadoId             BigInt                                   // Estado desde EstadosMultifuncion
  centroCostoId        BigInt?                                  // Centro de costo  
  movIngresoAlmacenId  BigInt?                                  // Movimiento de ingreso generado al recibir
  observaciones        String?     @db.Text                     // Notas, instrucciones especiales
  urlOrdenCompraPdf    String?                                  // PDF de la orden generada
  creadoEn             DateTime    @default(now())
  actualizadoEn        DateTime    @updatedAt
  creadoPor            BigInt?
  actualizadoPor       BigInt?
  porcentajeIGV         Decimal?                                // Porcentaje de IGV
  esExoneradoAlIGV      Boolean?   @default(false)             // Es exonerado al IGV
  
  requerimientoCompra  RequerimientoCompra? @relation(fields: [requerimientoCompraId], references: [id])
  proveedor            EntidadComercial @relation("ProveedorOrdenCompra", fields: [proveedorId], references: [id])
  formaPago            FormaPago? @relation(fields: [formaPagoId], references: [id])
  tipoDocumento        TipoDocumento @relation(fields: [tipoDocumentoId], references: [id])
  serieDoc             SerieDoc? @relation(fields: [serieDocId], references: [id])
  empresa              Empresa @relation(fields: [empresaId], references: [id])
  moneda               Moneda? @relation(fields: [monedaId], references: [id])
  estado               EstadoMultiFuncion @relation(fields: [estadoId], references: [id])
  insumosOT  DetInsumosTareaOT[] @relation("OCInsumoOT")

  detalles             DetalleOrdenCompra[]                     // Items de la orden
  
  @@index([empresaId, fechaDocumento])
  @@index([estadoId])
  @@index([proveedorId])
  @@index([requerimientoCompraId])
}

model Pais {
  id           BigInt         @id @default(autoincrement())
  codSUNAT     String         @unique
  nombre       String
  activo       Boolean        @default(true)
  gentilicio   String?

  departamentos Departamento[]
  ubigeos       Ubigeo[]
  requisitoDocPorPais RequisitoDocPorPais[]
}

model ParametroAprobador {
  id              BigInt    @id @default(autoincrement())
  personalRespId  BigInt
  moduloSistemaId BigInt
  empresaId       BigInt
  embarcacionId   BigInt?
  sedeId          BigInt?
  vigenteDesde    DateTime
  vigenteHasta    DateTime?
  cesado          Boolean   @default(false)
}

model PermisoAutorizacion {
  id                   BigInt                 @id @default(autoincrement())
  nombre               String                 @unique @db.VarChar(80)
  descripcion          String?
  activo               Boolean                @default(true)

  activosPermiso       DetallePermisoActivo[]
  permisosGestionados  DetPermisoGestionadoOT[]  
}

model DetallePermisoActivo {
  id                  BigInt              @id @default(autoincrement())
  activoId            BigInt
  permisoId           BigInt
  observaciones       String?
  obligatorio         Boolean             @default(true)

  activo         Activo              @relation(fields: [activoId], references: [id])
  permiso        PermisoAutorizacion @relation(fields: [permisoId], references: [id])

  @@unique([activoId, permisoId])
}

model Personal {
  id                    BigInt                  @id @default(autoincrement())
  empresaId             BigInt
  nombres               String
  apellidos             String
  tipoDocumentoId       BigInt?
  numeroDocumento       String
  fechaNacimiento       DateTime
  sexo                  Boolean                 @default(false)
  direccion             String?
  telefono              String?
  correo                String?
  fechaIngreso          DateTime?
  fechaCese             DateTime?
  tipoContratoId        BigInt?
  cargoId               BigInt?
  cesado                Boolean                 @default(false)
  areaFisicaId          BigInt?
  sedeEmpresaId         BigInt?
  urlFotoPersona        String?
  ubigeoId              BigInt?
  esVendedor            Boolean                 @default(false)
  paraPescaConsumo      Boolean                 @default(false)
  paraTemporadaPesca    Boolean                 @default(false)
  usuario       Usuario?
  
  documentaciones DocumentacionPersonal[]
  cargo       CargosPersonal?    @relation(fields: [cargoId], references: [id])
  ubigeo      Ubigeo?            @relation(fields: [ubigeoId], references: [id])
  tipoContrato TipoContrato?      @relation(fields: [tipoContratoId], references: [id])
  tipoDocIdentidad TiposDocIdentidad? @relation(fields: [tipoDocumentoId], references: [id])

   // Relaciones como Liquidador
  entregasLiquidadasVentas      EntregaARendirPVentas[] @relation("LiquidadorVentas")
  entregasLiquidadasIndustrial  EntregaARendir[] @relation("LiquidadorIndustrial")
  entregasLiquidadasCompras     EntregaARendirPCompras[] @relation("LiquidadorCompras")
  entregasLiquidadasConsumo     EntregaARendirPescaConsumo[] @relation("LiquidadorConsumo")
  
  // Relaciones como Responsable de Entrega
  entregasResponsableVentas     EntregaARendirPVentas[] @relation("ResponsableEntregaVentas")
  entregasResponsableIndustrial EntregaARendir[] @relation("ResponsableEntregaIndustrial")
  entregasResponsableCompras    EntregaARendirPCompras[] @relation("ResponsableEntregaCompras")
  entregasResponsableConsumo    EntregaARendirPescaConsumo[] @relation("ResponsableEntregaConsumo")

  entregasRendirInventarioLiquidadas EntregaARendirMovAlmacen[] @relation("LiquidadorInventario")
  entregasRendirInventarioResponsable EntregaARendirMovAlmacen[] @relation("ResponsableEntregaInventario")

  otSolicitadas    OTMantenimiento[] @relation("SolicitanteOT")
  otResponsable    OTMantenimiento[] @relation("ResponsableOT")
  otAutorizadas    OTMantenimiento[] @relation("AutorizadorOT")
  tareasResponsable DetTareasOT[] @relation("ResponsableTareaOT")
  tareasValidadas   DetTareasOT[] @relation("ValidadorTareaOT")
  insumosAprobados  DetInsumosTareaOT[] @relation("AprobadorComprasInsumoOT")
  otValidadas               OTMantenimiento[]       @relation("ValidadorOT")
    contratosResponsable    ContratoServicio[]    @relation("ContratoServicioResponsable")
  contratosAprobador      ContratoServicio[]    @relation("ContratoServicioAprobador")
    // Entregas a Rendir - Contratos de Servicios
  entregasRendirContratoServicioLiquidadas    EntregaARendirContratoServicios[] @relation("LiquidadorContratoServicio")
  entregasRendirContratoServicioResponsable   EntregaARendirContratoServicios[] @relation("ResponsableEntregaContratoServicio")
  movimientosContratoServicioResponsable      DetMovsEntregaRendirContratoServicios[] @relation("ResponsableMovContratoServicio")

}

model Producto {
  codigo                            String?                             @unique @db.VarChar(40)
  id                                BigInt                              @id @default(autoincrement())
  clienteId                         BigInt
  colorId                           BigInt
  descripcionArmada                 String
  descripcionBase                   String                              @db.VarChar(120)
  descripcionExtendida              String?                             @db.VarChar(120)
  estadoInicialId                   BigInt
  exoneradoIgv                      Boolean                             @default(false)
  familiaId                         BigInt
  fechaActualizacion                DateTime
  fechaCreacion                     DateTime                            @default(now())
  marcaId                           BigInt
  porcentajeDetraccion              Decimal?
  procedenciaId                     BigInt
  subfamiliaId                      BigInt
  tipoAlmacenamientoId              BigInt
  tipoMaterialId                    BigInt
  unidadAltoId                      BigInt?
  unidadAnchoId                     BigInt?
  unidadAnguloId                    BigInt?
  unidadDiametroId                  BigInt?
  unidadEspesorId                   BigInt?
  unidadLargoId                     BigInt?
  unidadMedidaId                    BigInt
  exoneradoRetencion                Boolean                             @default(false)
  sujetoDetraccion                  Boolean                             @default(false)
  empresaId                         BigInt
  aplicaColor                       Boolean                             @default(false)
  aplicaMarca                       Boolean                             @default(false)
  aplicaProcedencia                 Boolean                             @default(false)
  aplicaSubfamilia                  Boolean                             @default(false)
  aplicaTipoAlmacenamiento          Boolean                             @default(false)
  aplicaTipoMaterial                Boolean                             @default(false)
  aplicaUnidadMedida                Boolean                             @default(false)
  medidaAlto                        String?                             @db.VarChar(20)
  medidaAncho                       String?                             @db.VarChar(20)
  medidaAngulo                      String?                             @db.VarChar(20)
  medidaDiametro                    String?                             @db.VarChar(20)
  medidaEspesor                     String?                             @db.VarChar(20)
  medidaLargo                       String?                             @db.VarChar(20)
  urlFichaTecnica                   String?
  urlFotoProducto                   String?
  descripcionMedidaAdicional        String?                             @db.VarChar(120)
  especieId BigInt?
  cesado Boolean @default(false)
  //  AGREGAR: M谩rgenes de utilidad (heredados de Empresa, editables por producto)
  margenMinimoPermitido             Decimal?                            @db.Decimal(5, 2)  // % m铆nimo de margen
  margenUtilidadObjetivo            Decimal?                            @db.Decimal(5, 2)  // % objetivo de margen


  familia                 FamiliaProducto      @relation(fields: [familiaId], references: [id])
  subfamilia              SubfamiliaProducto?  @relation(fields: [subfamiliaId], references: [id])
  unidadMedida            UnidadMedida         @relation("UnidadMedidaToProducto", fields: [unidadMedidaId], references: [id])
  tipoMaterial            TipoMaterial?        @relation(fields: [tipoMaterialId], references: [id])
  color                   Color?               @relation(fields: [colorId], references: [id])
  tipoAlmacenamiento      TipoAlmacenamiento   @relation(fields: [tipoAlmacenamientoId], references: [id])
  marca                   Marca                @relation(fields: [marcaId], references: [id])
  detallesMovimiento      DetalleMovimientoAlmacen[]
  kardexAlmacenes   KardexAlmacen[]
  detallesRequerimientosCompra DetalleReqCompra[]
  detallesOrdenCompra     DetalleOrdenCompra[]
  detallesPreFactura DetallePreFactura[]
  detallesCotizacionVentas DetCotizacionVentas[]
  saldosDetProductoCliente SaldosDetProductoCliente[]
  saldosProductoCliente SaldosProductoCliente[]
  detalleCotizacionProveedor DetalleCotizacionProveedor[]
  detMovsEntregaRendirPCompras DetMovsEntregaRendirPCompras[]
  detMovsEntregaRendir DetMovsEntregaRendir[]
  detMovsEntregaRendirPescaConsumo DetMovsEntRendirPescaConsumo[]
  detMovsEntregaRendirPVentas DetMovsEntregaRendirPVentas[] @relation("MovimientoGastoExportacion")
  costosExportacionCotizacion CostosExportacionCotizacion[] @relation("CostoExportacionProducto")
  costosExportacionPorIncoterm CostoExportacionPorIncoterm[]
  precioEntidad PrecioEntidad[]
  movimientosCaja           MovimientoCaja[]
  detMovsEntregaRendirMovAlmacen DetMovsEntregaRendirMovAlmacen[]
  insumosOT  DetInsumosTareaOT[]
  serviciosContrato       DetServicioContrato[] @relation("ServicioContrato")
  movimientosContratoServicio    DetMovsEntregaRendirContratoServicios[]
}

model Provincia {
  id             BigInt       @id @default(autoincrement())
  codSUNAT       String       @unique
  nombre         String
  departamentoId BigInt

  departamento    Departamento @relation(fields: [departamentoId], references: [id])
  ubigeos         Ubigeo[]
}

model PuertoPesca {
  id                  BigInt   @id @default(autoincrement())
  zona                String   @db.VarChar(20)
  nombre              String   @db.VarChar(100)
  provincia           String?
  departamento        String?
  latitud             Decimal?
  longitud            Decimal?
  activo              Boolean  @default(true)
  fecha_creacion      DateTime @default(now())
  fecha_actualizacion DateTime
}

model RefreshToken {
  id         BigInt   @id @default(autoincrement())
  token      String   @unique
  usuarioId  BigInt
  expiracion DateTime
  creadoEn   DateTime @default(now())
  revocado   Boolean  @default(false)

  usuario     Usuario  @relation(fields: [usuarioId], references: [id])
}

/// Modelo profesional para almacenar los metadatos de los archivos de reportes generados por el sistema.
/// Cada registro representa un archivo de reporte generado y almacenado en el backend,
/// asociado a una empresa y opcionalmente a un subm贸dulo o proceso espec铆fico.
/// Documentado profesionalmente en espa帽ol t茅cnico.
model ReporteGenerado {
  id                BigInt    @id @default(autoincrement()) // Identificador 煤nico del reporte generado
  nombreArchivo     String    // Nombre f铆sico del archivo almacenado (incluye extensi贸n)
  rutaRelativa      String    // Ruta relativa donde se guarda el archivo, siguiendo la convenci贸n /uploads/reportes/empresa-{idEmpresa}/
  fechaGeneracion   DateTime  @default(now()) // Fecha y hora de la generaci贸n y almacenamiento del reporte
  empresaId         BigInt    // Empresa propietaria del reporte generado
  subModuloId       BigInt?   // Subm贸dulo o proceso origen del reporte (ej: id de faena, id de liquidaci贸n, etc.)
  usuarioGeneroId   BigInt?   // Usuario que gener贸 el reporte (opcional, para trazabilidad/auditor铆a)

  @@index([empresaId])
  @@index([subModuloId])
}

model SaldosDetProductoCliente {
  id               BigInt    @id @default(autoincrement())
  empresaId        BigInt    // Empresa (due帽a si esCustodia=false, custodia si esCustodia=true)
  almacenId        BigInt    // Almac茅n f铆sico donde est谩 el producto
  productoId       BigInt    // Producto espec铆fico
  clienteId        BigInt    // Cliente/Proveedor - Siempre tiene valor (entidadComercialId de la empresa o cliente real)
  esCustodia       Boolean   @default(false) // false=mercader铆a propia, true=mercader铆a en custodia
  
  // Variables de Control - Trazabilidad completa
  lote             String    @default("") @db.VarChar(40)  // N煤mero de lote de producci贸n
  fechaVencimiento DateTime? // Fecha de vencimiento del producto (null si no aplica)
  fechaProduccion  DateTime? // Fecha de producci贸n (null si no aplica)
  fechaIngreso     DateTime? // Fecha de ingreso al almac茅n (null si no aplica)
  numContenedor    String    @default("") @db.VarChar(40)  // N煤mero de contenedor (importaciones)
  nroSerie         String    @default("") @db.VarChar(40)  // N煤mero de serie (productos individuales)
  estadoId         BigInt?   // Estado de la mercader铆a (null si no aplica)
  estadoCalidadId  BigInt?   // Estado de calidad (null si no aplica)
  
  // Saldos - Siempre valores num茅ricos
  saldoCantidad    Decimal   @default(0) // Saldo en unidades
  saldoPeso        Decimal   @default(0) // Saldo en peso
  actualizadoEn    DateTime  // ltima actualizaci贸n del saldo

  // RELACIONES
  producto Producto         @relation(fields: [productoId], references: [id])
  cliente  EntidadComercial @relation(fields: [clienteId], references: [id])

  //  CONSTRAINT NICO ELIMINADO: PostgreSQL no maneja bien nulls en constraints 煤nicos compuestos
  // Soluci贸n profesional: Usar findFirst + update/create en lugar de upsert
  
  //  NDICES OPTIMIZADOS para performance (sin restricci贸n de unicidad)
  @@index([empresaId, almacenId, productoId, esCustodia, lote, fechaIngreso, fechaProduccion, fechaVencimiento, estadoId, estadoCalidadId, numContenedor, nroSerie], name: "idx_saldo_det_propio_completo")
  @@index([empresaId, almacenId, productoId, clienteId, esCustodia, lote, fechaIngreso, fechaProduccion, fechaVencimiento, estadoId, estadoCalidadId, numContenedor, nroSerie], name: "idx_saldo_det_custodia_completo")
  @@index([empresaId, almacenId, productoId, esCustodia], name: "idx_saldo_det_general")
}

model SaldosProductoCliente {
  id                    BigInt   @id @default(autoincrement())
  empresaId             BigInt   // Empresa (due帽a si custodia=false, custodia si custodia=true)
  almacenId             BigInt   // Almac茅n f铆sico
  productoId            BigInt   // Producto espec铆fico
  clienteId             BigInt   // Cliente/Proveedor - Siempre tiene valor (entidadComercialId de la empresa o cliente real)
  custodia              Boolean  @default(false) // false=mercader铆a propia, true=mercader铆a en custodia
  
  // Saldos Generales (sin variables de control) - Siempre valores num茅ricos
  saldoCantidad         Decimal  @default(0) // Saldo total en unidades
  saldoPeso             Decimal  @default(0) // Saldo total en peso
  costoUnitarioPromedio Decimal  @default(0) // Costo promedio ponderado (solo para mercader铆a propia)
  actualizadoEn         DateTime // ltima actualizaci贸n

  // RELACIONES
  producto Producto         @relation(fields: [productoId], references: [id])
  cliente  EntidadComercial @relation(fields: [clienteId], references: [id])

  //  CONSTRAINT NICO v谩lido (sin campos nullables)
  @@unique([empresaId, almacenId, productoId, clienteId, custodia], name: "uk_saldo_general_completo")
  
  // NDICES OPTIMIZADOS
  @@index([empresaId, almacenId, productoId, custodia], name: "idx_saldo_gen_propio")
  @@index([empresaId, almacenId, productoId, clienteId, custodia], name: "idx_saldo_gen_cliente")
}

model SedesEmpresa {
  id             BigInt           @id @default(autoincrement())
  empresaId      BigInt
  nombre         String
  direccion      String?
  telefono       String?
  email          String?
  cesado         Boolean          @default(false)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime

 empresa     Empresa  @relation(fields: [empresaId], references: [id])
 areasFisicas AreaFisicaSede[]
 ordenesMantenimiento OTMantenimiento[]
 contratosServicio       ContratoServicio[]    @relation("ContratoServicioSede")

}

model SerieDoc {
  id                BigInt              @id @default(autoincrement())
  tipoDocumentoId   BigInt
  tipoAlmacenId     BigInt
  serie             String              @db.VarChar(20)
  correlativo       BigInt              @default(0)
  numCerosIzqCorre  Int                 @default(0)
  numCerosIzqSerie  Int                 @default(0)
  activo            Boolean             @default(true)
  empresaId         BigInt?

  movimientos       MovimientoAlmacen[]
  requerimientosCompra RequerimientoCompra[]
  ordenesCompra OrdenCompra[]
  cotizacionesVentas CotizacionVentas[]
  preFacturas PreFactura[]
  ordenesMantenimiento OTMantenimiento[]
    contratosServicio       ContratoServicio[]    @relation("ContratoServicioSerie")
}

model SubfamiliaProducto {
  familiaId BigInt
  id        BigInt     @id @default(autoincrement())
  nombre    String     @db.VarChar(120)
  productos  Producto[]
  tiposProducto TipoProducto[]

}

model SubmoduloSistema {
  id             BigInt           @id @default(autoincrement())
  moduloId       BigInt
  nombre         String
  descripcion    String?
  ruta           String?          // Ej: "/compras/orden-compra" para routing
  icono          String?          // Ej: "pi pi-shopping-cart" para UI
  orden          Int?             // Para ordenar en el men煤
  activo         Boolean          @default(true)

  modulo         ModuloSistema @relation(fields: [moduloId], references: [id])
  accesosUsuario AccesosUsuario[]
  
  @@unique([moduloId, nombre])
  @@index([moduloId])
  @@index([activo])
}

model TemporadaPesca {
  id                        BigInt                     @id @default(autoincrement())
  nombre                    String
  fechaInicio               DateTime
  fechaFin                  DateTime
  cuotaAlquiladaTon         Decimal?
  cuotaPropiaTon            Decimal?
  empresaId                 BigInt
  fechaActualizacion        DateTime
  fechaCreacion             DateTime                   @default(now())
  numeroResolucion          String?
  urlResolucionPdf          String?
  BahiaId                   BigInt
  estadoTemporadaId         BigInt
  toneladasCapturadasTemporada     Decimal?
  temporadaPescaIniciada   Boolean @default(false)

  faenas               FaenaPesca[] @relation("FaenaTemporadas")
  entregasARendir      EntregaARendir[]
}

model TipoAccesoInstalacion {
  id                BigInt              @id @default(autoincrement())
  nombre            String              @unique
  descripcion       String?
  activo            Boolean             @default(true)

  accesos     AccesoInstalacion[]
}

model TipoActivo {
  id          BigInt   @id @default(autoincrement())
  codigo      String   @unique
  nombre      String
  descripcion String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime
  cesado      Boolean  @default(false)

  activos     Activo[]
}

model TipoAlmacen {
  id                 BigInt               @id @default(autoincrement())
  nombre             String               @db.VarChar(50)
  descripcion        String?
  activo             Boolean              @default(true)

  conceptos   ConceptoMovAlmacen[]
  almacenes   Almacen[]
}

model TipoAlmacenamiento {
  id       BigInt     @id @default(autoincrement())
  nombre   String     @db.VarChar(120)
  productos  Producto[]
  almacenes  Almacen[]
}

model TipoConcepto {
  id                 BigInt               @id @default(autoincrement())
  nombre             String               @db.VarChar(50)
  descripcion        String?
  activo             Boolean              @default(true)

  conceptos   ConceptoMovAlmacen[]
}

model TipoContrato {
  id        BigInt     @id @default(autoincrement())
  codigo    String     @unique
  nombre    String
  cesado    Boolean    @default(false)
  createdAt DateTime   @default(now())
  updatedAt DateTime

  personal Personal[]
}

model TipoCuentaCorriente {
  id              BigInt            @id @default(autoincrement())
  nombre          String            @unique
  descripcion     String?
  activo          Boolean           @default(true)

  cuentas     CuentaCorriente[]
}

model TipoDocumento {
  id                BigInt              @id @default(autoincrement())
  codigo            String              @unique @db.VarChar(10)
  codigoSunat       String?             @db.VarChar(10)
  descripcion       String?
  activo            Boolean             @default(true)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime
  esParaAlmacen     Boolean             @default(false)
  esParaCompras     Boolean             @default(false)
  esParaVentas      Boolean             @default(false)

  movimientosAlmacen MovimientoAlmacen[]
  detMovsEntregaRendirPCompras DetMovsEntregaRendirPCompras[]
  detMovsEntregaRendirPVentas DetMovsEntregaRendirPVentas[]
  requerimientosCompra RequerimientoCompra[]
  ordenesCompra OrdenCompra[]
  detMovsEntregaRendirPescaConsumo DetMovsEntRendirPescaConsumo[]
  detMovsEntregaRendir DetMovsEntregaRendir[]
  cotizacionesVentas CotizacionVentas[]
  preFacturas PreFactura[]
  detMovsEntregaRendirMovAlmacen DetMovsEntregaRendirMovAlmacen[]
  ordenesMantenimiento OTMantenimiento[]
  contratosServicio       ContratoServicio[]    @relation("ContratoServicioTipoDoc")
  movimientosContratoServicio    DetMovsEntregaRendirContratoServicios[]
}

model TipoEmbarcacion {
  id          BigInt        @id @default(autoincrement())
  codigo      String        @unique
  nombre      String
  descripcion String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime
  cesado      Boolean       @default(false)

  embarcaciones Embarcacion[]
}

model TipoEntidad {
  id               BigInt             @id @default(autoincrement())
  descripcion      String?
  activo           Boolean            @default(true)
  esCliente        Boolean            @default(false)
  esProveedor      Boolean            @default(false)
  nombre           String             @db.VarChar(50)

  entidades   EntidadComercial[]
}

model TipoEquipo {
  id                BigInt              @id @default(autoincrement())
  nombre            String              @unique
  descripcion       String?
  activo            Boolean             @default(true)

  accesos     AccesoInstalacion[]
}



model TipoMaterial {
  id       BigInt     @id @default(autoincrement())
  nombre   String     @db.VarChar(80)
  codigo   String     @db.VarChar(10)

  productos               Producto[]
}

model TipoMovEntregaRendir {
  id                           BigInt                         @id @default(autoincrement())
  nombre                       String                         @db.VarChar(50)
  descripcion                  String?
  esIngreso                    Boolean
  activo                       Boolean                        @default(true)

  detMovsEntregaRendir DetMovsEntregaRendir[]
  movimientosConsumo DetMovsEntRendirPescaConsumo[]
  movimientosVentas DetMovsEntregaRendirPVentas[]
  movimientosCompras DetMovsEntregaRendirPCompras[]
  movimientosCaja  MovimientoCaja[]
  detMovsEntregaRendirMovAlmacen DetMovsEntregaRendirMovAlmacen[]
  movimientosContratoServicio    DetMovsEntregaRendirContratoServicios[]

}

model TipoMovimientoAcceso {
  id                       BigInt                     @id @default(autoincrement())
  nombre                   String                     @unique
  descripcion              String?
  activo                   Boolean                    @default(true)

  detalles    AccesoInstalacionDetalle[]
}

model TipoMovimientoAlmacen {
  id                 BigInt               @id @default(autoincrement())
  nombre             String               @db.VarChar(30)
  descripcion        String?
  activo             Boolean              @default(true)

  conceptos   ConceptoMovAlmacen[]
}

model TipoPersona {
  id                BigInt              @id @default(autoincrement())
  nombre            String              @unique
  descripcion       String?
  activo            Boolean             @default(true)
  imprimeTicketIng  Boolean             @default(true)

  accesos     AccesoInstalacion[]
}

model TipoProducto {
  id                  BigInt              @id @default(autoincrement())
  subfamiliaId        BigInt?              // AGREGAR
  nombre              String              @unique @db.VarChar(100)
  descripcion         String?             @db.Text  // Cambiar a Text
  activo              Boolean             @default(true)
  paraCompras         Boolean             @default(false)
  paraVentas          Boolean             @default(false)
  
  //AGREGAR: Auditor铆a
  fechaCreacion       DateTime            @default(now())
  fechaActualizacion  DateTime?           @updatedAt
  creadoPor           BigInt?
  actualizadoPor      BigInt?

  // Relaciones
 subfamilia              SubfamiliaProducto?  @relation(fields: [subfamiliaId], references: [id])
 cotizacionesVentas      CotizacionVentas[]
 requisitoDocPorPais     RequisitoDocPorPais[]
 requerimientosCompra    RequerimientoCompra[]
  
  @@index([subfamiliaId])
}

model TipoEstadoProducto {
  id                BigInt              @id @default(autoincrement())
  nombre            String              @unique
  descripcion       String?
  activo            Boolean             @default(true)
  paraCompras       Boolean             @default(false)
  paraVentas        Boolean             @default(false)

  cotizacionesVentas CotizacionVentas[]
  requerimientosCompra  RequerimientoCompra[]
}

model DestinoProducto {
  id                BigInt              @id @default(autoincrement())
  nombre            String              @unique
  descripcion       String?
  activo            Boolean             @default(true)
  paraCompras       Boolean             @default(false)
  paraVentas        Boolean             @default(false)

  cotizacionesVentas CotizacionVentas[]
  requerimientosCompra  RequerimientoCompra[]
}

model FormaTransaccion {
  id                BigInt              @id @default(autoincrement())
  nombre            String              @unique
  descripcion       String?
  activo            Boolean             @default(true)

  cotizaciones   CotizacionVentas[]
}

model ModoDespachoRecepcion {
  id                BigInt              @id @default(autoincrement())
  nombre            String              @unique
  descripcion       String?
  activo            Boolean             @default(true)

  cotizacionesVentas CotizacionVentas[]
  requerimientosCompra  RequerimientoCompra[]
}

model TipoProvieneDe {
  id                 BigInt               @id @default(autoincrement())
  descripcion        String?
  cesado             Boolean              @default(false)
  createdAt          DateTime             @default(now())
  updatedAt          DateTime

  estados     EstadoMultiFuncion[]

}

model TipoReferenciaMovimientoCaja {
  id             BigInt           @id @default(autoincrement())
  codigo         String           @unique @db.VarChar(30)
  descripcion    String?
  activo         Boolean          @default(true)

  movimientos MovimientoCaja[]
}

model TipoVehiculo {
  id              BigInt            @id @default(autoincrement())
  nombre          String            @db.VarChar(50)
  activo          Boolean           @default(true)

  vehiculos   VehiculoEntidad[]
}

model TiposDocIdentidad {
  id               BigInt             @id @default(autoincrement())
  codigo           String             @unique
  nombre           String
  cesado           Boolean            @default(false)
  createdAt        DateTime           @default(now())
  updatedAt        DateTime
  codSunat         String

  entidadesComerciales EntidadComercial[]
  personal Personal[]
}

model TripulanteFaena {
  id            BigInt     @id @default(autoincrement())
  faenaPescaId  BigInt
  personalId    BigInt?
  cargoId       BigInt?
  nombres       String?
  apellidos     String?
  observaciones String?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime

  faenaPesca   FaenaPesca @relation(fields: [faenaPescaId], references: [id])
}

model TripulanteFaenaConsumo {
  id                  BigInt            @id @default(autoincrement())
  faenaPescaConsumoId BigInt
  personalId          BigInt?
  cargoId             BigInt?
  nombres             String?
  apellidos           String?
  observaciones       String?
  createdAt           DateTime          @default(now())
  updatedAt           DateTime

faenaPescaConsumo    FaenaPescaConsumo @relation(fields: [faenaPescaConsumoId], references: [id])
}

// ============================================
// MDULO DE MANTENIMIENTO
// ============================================

model OTMantenimiento {
  id                     BigInt    @id @default(autoincrement())
  codigo                 String    @unique @db.VarChar(30)
  empresaId              BigInt
  tipoDocumentoId        BigInt
  serieDocId             BigInt?
  numeroDocumento        String?
  fechaDocumento         DateTime  @default(now())
  sedeId                 BigInt?
  activoId               BigInt
  tipoMantenimientoId    BigInt
  motivoOriginoId        BigInt
  prioridadAlta          Boolean   @default(false)
  estadoId               BigInt
  fechaProgramada        DateTime?
  fechaInicio            DateTime?
  fechaFin               DateTime?
  monedaId               BigInt
  solicitanteId          BigInt?
  responsableId          BigInt?
  autorizadoPorId        BigInt?
  validadoPorId          BigInt? 
  descripcionProblema    String?   @db.Text
  solucionAplicada       String?   @db.Text
  observaciones          String?   @db.Text
  urlFotosAntesPdf       String?
  urlFotosDespuesPdf     String?
  urlOrdenTrabajoPdf     String?
  planMantenimientoId    BigInt?
  creadoEn               DateTime  @default(now())
  actualizadoEn          DateTime  @updatedAt
  creadoPor              BigInt?
  actualizadoPor         BigInt?

  empresa                Empresa             @relation(fields: [empresaId], references: [id])
  sede                   SedesEmpresa?       @relation(fields: [sedeId], references: [id])
  activo                 Activo              @relation(fields: [activoId], references: [id])
  tipoMantenimiento      TipoMantenimiento   @relation(fields: [tipoMantenimientoId], references: [id])
  motivoOrigino          MotivoOriginoOT     @relation(fields: [motivoOriginoId], references: [id])
  estado                 EstadoMultiFuncion  @relation(fields: [estadoId], references: [id])
  moneda                 Moneda              @relation(fields: [monedaId], references: [id])
  solicitante            Personal?           @relation("SolicitanteOT", fields: [solicitanteId], references: [id])
  responsable            Personal?           @relation("ResponsableOT", fields: [responsableId], references: [id])
  autorizadoPor          Personal?           @relation("AutorizadorOT", fields: [autorizadoPorId], references: [id])
  validadoPor            Personal?           @relation("ValidadorOT", fields: [validadoPorId], references: [id])
  tipoDocumento          TipoDocumento       @relation(fields: [tipoDocumentoId], references: [id])
  serieDoc               SerieDoc?           @relation(fields: [serieDocId], references: [id])

  permisosGestionados    DetPermisoGestionadoOT[]
  tareas                 DetTareasOT[]
}

model TipoMantenimiento {
  id                      BigInt    @id @default(autoincrement())
  nombre                  String    @unique @db.VarChar(20)
  descripcion             String?   @db.Text
  activo                  Boolean   @default(true)

  ordenesMantenimiento    OTMantenimiento[]
}

model DetTareasOT {
  id                           BigInt              @id @default(autoincrement())
  otMantenimientoId            BigInt
  numeroTarea                  Int
  descripcion                  String              @db.Text
  responsableId                BigInt?
  personalValidaId             BigInt?
  contratistaId                BigInt?
  fechaProgramada              DateTime?
  fechaInicio                  DateTime?
  fechaFin                     DateTime?
  estadoTareaId                BigInt
  realizado                    Boolean             @default(false)
  observaciones                String?             @db.Text
  creadoEn                     DateTime            @default(now())
  actualizadoEn                DateTime            @updatedAt
  creadoPor                    BigInt?
  actualizadoPor               BigInt?

  otMantenimiento              OTMantenimiento     @relation(fields: [otMantenimientoId], references: [id], onDelete: Cascade)
  estadoTarea                  EstadoMultiFuncion  @relation("EstadoTareaOT", fields: [estadoTareaId], references: [id])
  responsable                  Personal?           @relation("ResponsableTareaOT", fields: [responsableId], references: [id])
  personalValida               Personal?           @relation("ValidadorTareaOT", fields: [personalValidaId], references: [id])
  contratista                  EntidadComercial?   @relation("ContratistaTareaOT", fields: [contratistaId], references: [id])
  insumos                      DetInsumosTareaOT[]

  @@unique([otMantenimientoId, numeroTarea])
}

model DetInsumosTareaOT {
  id                          BigInt    @id @default(autoincrement())
  tareaId                     BigInt
  productoId                  BigInt
  cantidadRequerida           Decimal
  cantidadConsumida           Decimal   @default(0)
  estadoInsumoId              BigInt
  movimientoAlmacenId         BigInt?
  detalleMovAlmacenId         BigInt?
  ordenCompraId               BigInt?
  detalleOrdenCompraId        BigInt?
  proveedorSugeridoId         BigInt?
  personalApruebaComprasId    BigInt?
  observaciones               String?   @db.Text
  creadoEn                    DateTime  @default(now())
  actualizadoEn               DateTime  @updatedAt
  creadoPor                   BigInt?
  actualizadoPor              BigInt?

  tarea                       DetTareasOT              @relation(fields: [tareaId], references: [id], onDelete: Cascade)
  producto                    Producto                 @relation(fields: [productoId], references: [id])
  estadoInsumo                EstadoMultiFuncion       @relation("EstadoInsumoOT", fields: [estadoInsumoId], references: [id])
  movimientoAlmacen           MovimientoAlmacen?       @relation("MovAlmacenInsumoOT", fields: [movimientoAlmacenId], references: [id])
  detalleMovAlmacen           DetalleMovimientoAlmacen? @relation("DetMovAlmacenInsumoOT", fields: [detalleMovAlmacenId], references: [id])
  ordenCompra                 OrdenCompra?             @relation("OCInsumoOT", fields: [ordenCompraId], references: [id])
  detalleOrdenCompra          DetalleOrdenCompra?      @relation("DetOCInsumoOT", fields: [detalleOrdenCompraId], references: [id])
  proveedorSugerido           EntidadComercial?        @relation("ProveedorSugeridoInsumoOT", fields: [proveedorSugeridoId], references: [id])
  personalApruebaCompras      Personal?                @relation("AprobadorComprasInsumoOT", fields: [personalApruebaComprasId], references: [id])

}

model Ubigeo {
  id               BigInt             @id @default(autoincrement())
  codigo           String             @unique
  activo           Boolean            @default(true)
  departamentoId   BigInt
  paisId           BigInt
  provinciaId      BigInt
  nombreDistrito   String?

  pais         Pais         @relation(fields: [paisId], references: [id])
  departamento Departamento @relation(fields: [departamentoId], references: [id])
  provincia    Provincia    @relation(fields: [provinciaId], references: [id])

  direcciones  DireccionEntidad[]
  personas     Personal[]
}

model UnidadMedida {
  nombre           String     @db.VarChar(60)
  simbolo          String     @db.VarChar(20)
  id               BigInt     @id @default(autoincrement())
  esMedidaMetrica  Boolean    @default(false)
  factorConversion Decimal?

  productos           Producto[]      @relation("UnidadMedidaToProducto")
}

model Usuario {
  id                BigInt           @id @default(autoincrement())
  username          String           @unique
  passwordHash      String
  fechaCreacion     DateTime         @default(now())
  fechaUltimoAcceso DateTime?
  personalId        BigInt?          @unique
  empresaId         BigInt
  esAdmin           Boolean          @default(false)
  esSuperUsuario    Boolean          @default(false)
  esUsuario         Boolean          @default(true)
  activo            Boolean          @default(true)   // Estado del usuario en el sistema
  intentosFallidos  Int              @default(0)      // Seguridad: bloqueo por intentos
  bloqueadoHasta    DateTime?        // Seguridad: bloqueo temporal
  motivoInactivacion String?         // Raz贸n de desactivaci贸n (opcional)
  inactivadoPor     BigInt?          // Qui茅n desactiv贸 (auditor铆a)
  fechaInactivacion DateTime?        // Cu谩ndo se desactiv贸

  personal          Personal? @relation(fields: [personalId], references: [id])
  empresa           Empresa @relation(fields: [empresaId], references: [id])
  accesosUsuario    AccesosUsuario[]
  refreshTokens     RefreshToken[]
  
  @@index([empresaId])
  @@index([personalId])
  @@index([activo])
  @@index([username])
}

model ContratoServicio {
  id                      BigInt                @id @default(autoincrement())
  
  // Relaciones Organizacionales
  empresaId               BigInt
  sedeId                  BigInt
  activoId                BigInt?
  almacenId               BigInt
  clienteId               BigInt
  contactoClienteId       BigInt?
  
  // Responsables
  responsableId           BigInt
  aprobadorId             BigInt?
  
  // Documento
  tipoDocumentoId         BigInt
  serieDocId              BigInt
  numeroSerie             String                @db.VarChar(10)
  numeroCorrelativo       Int
  numeroCompleto          String                @db.VarChar(20)
  
  // Fechas
  fechaCelebracion        DateTime
  fechaInicioContrato     DateTime
  fechaFinContrato        DateTime?
  fechaInicioCobro        DateTime
  periodicidadCobro       Int                   @default(1)
  
  // Contenido
  textoEsenciaContrato    String                @db.Text
  urlContratoPdf          String?               @db.VarChar(500)
  
  // Configuraci贸n de Luz
  incluyeLuz              Boolean               @default(false)
  porcentajeRecargoLuz    Decimal?              @db.Decimal(5, 2)
  costoPorKilovatio       Decimal?              @db.Decimal(10, 4)
  
  // Financiero
  monedaId                BigInt
  tipoCambio              Decimal               @db.Decimal(10, 4)
  estadoContratoId        BigInt
  
  // Auditor铆a
  creadoPor               BigInt?
  creadoEn                DateTime              @default(now())
  actualizadoPor          BigInt?
  actualizadoEn           DateTime              @updatedAt
  
  // Relaciones
  empresa                 Empresa               @relation("ContratoServicioEmpresa", fields: [empresaId], references: [id])
  sede                    SedesEmpresa          @relation("ContratoServicioSede", fields: [sedeId], references: [id])
  activo                  Activo?               @relation("ContratoServicioActivo", fields: [activoId], references: [id])
  almacen                 Almacen               @relation("ContratoServicioAlmacen", fields: [almacenId], references: [id])
  cliente                 EntidadComercial      @relation("ContratoServicioCliente", fields: [clienteId], references: [id])
  contactoCliente         ContactoEntidad?      @relation("ContratoServicioContacto", fields: [contactoClienteId], references: [id])
  responsable             Personal              @relation("ContratoServicioResponsable", fields: [responsableId], references: [id])
  aprobador               Personal?             @relation("ContratoServicioAprobador", fields: [aprobadorId], references: [id])
  tipoDocumento           TipoDocumento         @relation("ContratoServicioTipoDoc", fields: [tipoDocumentoId], references: [id])
  serieDoc                SerieDoc              @relation("ContratoServicioSerie", fields: [serieDocId], references: [id])
  moneda                  Moneda                @relation("ContratoServicioMoneda", fields: [monedaId], references: [id])
  estadoContrato          EstadoMultiFuncion    @relation("EstadoContratoServicio", fields: [estadoContratoId], references: [id])
  entregaARendir          EntregaARendirContratoServicios? @relation("EntregaRendirContrato")
  detallesServicios       DetServicioContrato[]
  prefacturas             PreFactura[]          @relation("PreFacturaContrato")
  
  @@index([empresaId, clienteId])
  @@index([almacenId])
  @@index([estadoContratoId])
  @@index([fechaInicioCobro])
  @@index([responsableId])
}

model DetServicioContrato {
  id                      BigInt                @id @default(autoincrement())
  contratoServicioId      BigInt
  productoServicioId      BigInt                // Producto que representa el servicio
  
  // Datos del Servicio
  cantidad                Decimal               @db.Decimal(18, 4)
  valorVentaUnitario      Decimal               @db.Decimal(18, 4)
  incluyeLuz              Boolean               @default(false)
  
  // Auditor铆a
  creadoPor               BigInt?
  creadoEn                DateTime              @default(now())
  actualizadoPor          BigInt?
  actualizadoEn           DateTime              @updatedAt
  
  // Relaciones
  contratoServicio        ContratoServicio      @relation(fields: [contratoServicioId], references: [id], onDelete: Cascade)
  productoServicio        Producto              @relation("ServicioContrato", fields: [productoServicioId], references: [id])
  
  @@index([contratoServicioId])
  @@index([productoServicioId])
}